# -*- coding: utf-8 -*-
***REMOVED***
    jinja2.optimizer
    ~~~~~~~~~~~~~~~~

    The jinja optimizer is currently trying to constant fold a few expressions
    and modify the AST in place so that it should be easier to evaluate it.

    Because the AST does not contain all the scoping information and the
    compiler has to find that out, we cannot do all the optimizations we
    want.  For example loop unrolling doesn't work because unrolled loops would
    have a different scoping.

    The solution would be a second syntax tree that has the scoping rules stored.

    :copyright: (c***REMOVED*** 2010 by the Jinja Team.
    :license: BSD.
***REMOVED***
from jinja2 import nodes
from jinja2.visitor import NodeTransformer


def optimize(node, environment***REMOVED***:
    ***REMOVED***The context hint can be used to perform an static optimization
    based on the context given.***REMOVED***
    optimizer = Optimizer(environment***REMOVED***
    return optimizer.visit(node***REMOVED***


class Optimizer(NodeTransformer***REMOVED***:

    def __init__(self, environment***REMOVED***:
        self.environment = environment

    def visit_If(self, node***REMOVED***:
        ***REMOVED***Eliminate dead code.***REMOVED***
        # do not optimize ifs that have a block inside so that it doesn't
        # break super(***REMOVED***.
        if node.find(nodes.Block***REMOVED*** is not None:
            return self.generic_visit(node***REMOVED***
        ***REMOVED***
            val = self.visit(node.test***REMOVED***.as_const(***REMOVED***
        except nodes.Impossible:
            return self.generic_visit(node***REMOVED***
        if val:
            body = node.body
        else:
            body = node.else_
        result = [***REMOVED***
        for node in body:
            result.extend(self.visit_list(node***REMOVED******REMOVED***
        return result

    def fold(self, node***REMOVED***:
        ***REMOVED***Do constant folding.***REMOVED***
        node = self.generic_visit(node***REMOVED***
        ***REMOVED***
            return nodes.Const.from_untrusted(node.as_const(***REMOVED***,
                                              lineno=node.lineno,
                                              environment=self.environment***REMOVED***
        except nodes.Impossible:
            return node

    visit_Add = visit_Sub = visit_Mul = visit_Div = visit_FloorDiv = \
    visit_Pow = visit_Mod = visit_And = visit_Or = visit_Pos = visit_Neg = \
    visit_Not = visit_Compare = visit_Getitem = visit_Getattr = visit_Call = \
    visit_Filter = visit_Test = visit_CondExpr = fold
    del fold
