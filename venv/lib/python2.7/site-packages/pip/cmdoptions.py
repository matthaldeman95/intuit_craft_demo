***REMOVED***
shared options and groups

The principle here is to define options once, but *not* instantiate them
globally. One reason being that options with action='append' can carry state
between parses. pip parses general options twice internally, and shouldn't
pass on state. To be consistent, all options will follow this design.

***REMOVED***
from __future__ import absolute_import

from functools import partial
from optparse import OptionGroup, SUPPRESS_HELP, Option
import warnings

from pip.index import (
    FormatControl, fmt_ctl_handle_mutual_exclude, fmt_ctl_no_binary,
    fmt_ctl_no_use_wheel***REMOVED***
from pip.models import PyPI
from pip.locations import USER_CACHE_DIR, src_prefix
from pip.utils.hashes import STRONG_HASHES


def make_option_group(group, parser***REMOVED***:
    ***REMOVED***
    Return an OptionGroup object
    group  -- assumed to be dict with 'name' and 'options' keys
    parser -- an optparse Parser
    ***REMOVED***
    option_group = OptionGroup(parser, group['name'***REMOVED******REMOVED***
    for option in group['options'***REMOVED***:
        option_group.add_option(option(***REMOVED******REMOVED***
    return option_group


def resolve_wheel_no_use_binary(options***REMOVED***:
    if not options.use_wheel:
        control = options.format_control
        fmt_ctl_no_use_wheel(control***REMOVED***


def check_install_build_global(options, check_options=None***REMOVED***:
    ***REMOVED***Disable wheels if per-setup.py call options are set.

    :param options: The OptionParser options to update.
    :param check_options: The options to check, if not supplied defaults to
        options.
    ***REMOVED***
    if check_options is None:
        check_options = options

    def getname(n***REMOVED***:
        return getattr(check_options, n, None***REMOVED***
    names = ["build_options", "global_options", "install_options"***REMOVED***
    if any(map(getname, names***REMOVED******REMOVED***:
        control = options.format_control
        fmt_ctl_no_binary(control***REMOVED***
        warnings.warn(
            'Disabling all use of wheels due to the use of --build-options '
            '/ --global-options / --install-options.', stacklevel=2***REMOVED***


###########
# options #
###########

help_ = partial(
    Option,
    '-h', '--help',
    dest='help',
    action='help',
    help='Show help.'***REMOVED***

isolated_mode = partial(
    Option,
    "--isolated",
    dest="isolated_mode",
    action="store_true",
    default=False,
    help=(
        "Run pip in an isolated mode, ignoring environment variables and user "
        "configuration."
    ***REMOVED***,
***REMOVED***

require_virtualenv = partial(
    Option,
    # Run only if inside a virtualenv, bail if not.
    '--require-virtualenv', '--require-venv',
    dest='require_venv',
    action='store_true',
    default=False,
    help=SUPPRESS_HELP***REMOVED***

verbose = partial(
    Option,
    '-v', '--verbose',
    dest='verbose',
    action='count',
    default=0,
    help='Give more output. Option is additive, and can be used up to 3 times.'
***REMOVED***

version = partial(
    Option,
    '-V', '--version',
    dest='version',
    action='store_true',
    help='Show version and exit.'***REMOVED***

quiet = partial(
    Option,
    '-q', '--quiet',
    dest='quiet',
    action='count',
    default=0,
    help='Give less output.'***REMOVED***

log = partial(
    Option,
    "--log", "--log-file", "--local-log",
    dest="log",
    metavar="path",
    help="Path to a verbose appending log."
***REMOVED***

no_input = partial(
    Option,
    # Don't ask for input
    '--no-input',
    dest='no_input',
    action='store_true',
    default=False,
    help=SUPPRESS_HELP***REMOVED***

proxy = partial(
    Option,
    '--proxy',
    dest='proxy',
    type='str',
    default='',
    help="Specify a proxy in the form [user:passwd@***REMOVED***proxy.server:port."***REMOVED***

retries = partial(
    Option,
    '--retries',
    dest='retries',
    type='int',
    default=5,
    help="Maximum number of retries each connection should attempt "
         "(default %default times***REMOVED***."***REMOVED***

timeout = partial(
    Option,
    '--timeout', '--default-timeout',
    metavar='sec',
    dest='timeout',
    type='float',
    default=15,
    help='Set the socket timeout (default %default seconds***REMOVED***.'***REMOVED***

default_vcs = partial(
    Option,
    # The default version control system for editables, e.g. 'svn'
    '--default-vcs',
    dest='default_vcs',
    type='str',
    default='',
    help=SUPPRESS_HELP***REMOVED***

skip_requirements_regex = partial(
    Option,
    # A regex to be used to skip requirements
    '--skip-requirements-regex',
    dest='skip_requirements_regex',
    type='str',
    default='',
    help=SUPPRESS_HELP***REMOVED***


def exists_action(***REMOVED***:
    return Option(
        # Option when path already exist
        '--exists-action',
        dest='exists_action',
        type='choice',
        choices=['s', 'i', 'w', 'b'***REMOVED***,
        default=[***REMOVED***,
        action='append',
        metavar='action',
        help="Default action when a path already exists: "
        "(s***REMOVED***witch, (i***REMOVED***gnore, (w***REMOVED***ipe, (b***REMOVED***ackup."***REMOVED***


cert = partial(
    Option,
    '--cert',
    dest='cert',
    type='str',
    metavar='path',
    help="Path to alternate CA bundle."***REMOVED***

client_cert = partial(
    Option,
    '--client-cert',
    dest='client_cert',
    type='str',
    default=None,
    metavar='path',
    help="Path to SSL client certificate, a single file containing the "
         "private key and the certificate in PEM format."***REMOVED***

index_url = partial(
    Option,
    '-i', '--index-url', '--pypi-url',
    dest='index_url',
    metavar='URL',
    default=PyPI.simple_url,
    help='Base URL of Python Package Index (default %default***REMOVED***.'***REMOVED***


def extra_index_url(***REMOVED***:
    return Option(
        '--extra-index-url',
        dest='extra_index_urls',
        metavar='URL',
        action='append',
        default=[***REMOVED***,
        help='Extra URLs of package indexes to use in addition to --index-url.'
    ***REMOVED***


no_index = partial(
    Option,
    '--no-index',
    dest='no_index',
    action='store_true',
    default=False,
    help='Ignore package index (only looking at --find-links URLs instead***REMOVED***.'***REMOVED***


def find_links(***REMOVED***:
    return Option(
        '-f', '--find-links',
        dest='find_links',
        action='append',
        default=[***REMOVED***,
        metavar='url',
        help="If a url or path to an html file, then parse for links to "
             "archives. If a local path or file:// url that's a directory, "
             "then look for archives in the directory listing."***REMOVED***


def allow_external(***REMOVED***:
    return Option(
        "--allow-external",
        dest="allow_external",
        action="append",
        default=[***REMOVED***,
        metavar="PACKAGE",
        help=SUPPRESS_HELP,
    ***REMOVED***


allow_all_external = partial(
    Option,
    "--allow-all-external",
    dest="allow_all_external",
    action="store_true",
    default=False,
    help=SUPPRESS_HELP,
***REMOVED***


def trusted_host(***REMOVED***:
    return Option(
        "--trusted-host",
        dest="trusted_hosts",
        action="append",
        metavar="HOSTNAME",
        default=[***REMOVED***,
        help="Mark this host as trusted, even though it does not have valid "
             "or any HTTPS.",
    ***REMOVED***


# Remove after 7.0
no_allow_external = partial(
    Option,
    "--no-allow-external",
    dest="allow_all_external",
    action="store_false",
    default=False,
    help=SUPPRESS_HELP,
***REMOVED***


# Remove --allow-insecure after 7.0
def allow_unsafe(***REMOVED***:
    return Option(
        "--allow-unverified", "--allow-insecure",
        dest="allow_unverified",
        action="append",
        default=[***REMOVED***,
        metavar="PACKAGE",
        help=SUPPRESS_HELP,
    ***REMOVED***

# Remove after 7.0
no_allow_unsafe = partial(
    Option,
    "--no-allow-insecure",
    dest="allow_all_insecure",
    action="store_false",
    default=False,
    help=SUPPRESS_HELP
***REMOVED***

# Remove after 1.5
process_dependency_links = partial(
    Option,
    "--process-dependency-links",
    dest="process_dependency_links",
    action="store_true",
    default=False,
    help="Enable the processing of dependency links.",
***REMOVED***


def constraints(***REMOVED***:
    return Option(
        '-c', '--constraint',
        dest='constraints',
        action='append',
        default=[***REMOVED***,
        metavar='file',
        help='Constrain versions using the given constraints file. '
        'This option can be used multiple times.'***REMOVED***


def requirements(***REMOVED***:
    return Option(
        '-r', '--requirement',
        dest='requirements',
        action='append',
        default=[***REMOVED***,
        metavar='file',
        help='Install from the given requirements file. '
        'This option can be used multiple times.'***REMOVED***


def editable(***REMOVED***:
    return Option(
        '-e', '--editable',
        dest='editables',
        action='append',
        default=[***REMOVED***,
        metavar='path/url',
        help=('Install a project in editable mode (i.e. setuptools '
              '"develop mode"***REMOVED*** from a local project path or a VCS url.'***REMOVED***,
    ***REMOVED***

src = partial(
    Option,
    '--src', '--source', '--source-dir', '--source-directory',
    dest='src_dir',
    metavar='dir',
    default=src_prefix,
    help='Directory to check out editable projects into. '
    'The default in a virtualenv is "<venv path>/src". '
    'The default for global installs is "<current dir>/src".'
***REMOVED***

# XXX: deprecated, remove in 9.0
use_wheel = partial(
    Option,
    '--use-wheel',
    dest='use_wheel',
    action='store_true',
    default=True,
    help=SUPPRESS_HELP,
***REMOVED***

# XXX: deprecated, remove in 9.0
no_use_wheel = partial(
    Option,
    '--no-use-wheel',
    dest='use_wheel',
    action='store_false',
    default=True,
    help=('Do not Find and prefer wheel archives when searching indexes and '
          'find-links locations. DEPRECATED in favour of --no-binary.'***REMOVED***,
***REMOVED***


def _get_format_control(values, option***REMOVED***:
    ***REMOVED***Get a format_control object.***REMOVED***
    return getattr(values, option.dest***REMOVED***


def _handle_no_binary(option, opt_str, value, parser***REMOVED***:
    existing = getattr(parser.values, option.dest***REMOVED***
    fmt_ctl_handle_mutual_exclude(
        value, existing.no_binary, existing.only_binary***REMOVED***


def _handle_only_binary(option, opt_str, value, parser***REMOVED***:
    existing = getattr(parser.values, option.dest***REMOVED***
    fmt_ctl_handle_mutual_exclude(
        value, existing.only_binary, existing.no_binary***REMOVED***


def no_binary(***REMOVED***:
    return Option(
        "--no-binary", dest="format_control", action="callback",
        callback=_handle_no_binary, type="str",
        default=FormatControl(set(***REMOVED***, set(***REMOVED******REMOVED***,
        help="Do not use binary packages. Can be supplied multiple times, and "
             "each time adds to the existing value. Accepts either :all: to "
             "disable all binary packages, :none: to empty the set, or one or "
             "more package names with commas between them. Note that some "
             "packages are tricky to compile and may fail to install when "
             "this option is used on them."***REMOVED***


def only_binary(***REMOVED***:
    return Option(
        "--only-binary", dest="format_control", action="callback",
        callback=_handle_only_binary, type="str",
        default=FormatControl(set(***REMOVED***, set(***REMOVED******REMOVED***,
        help="Do not use source packages. Can be supplied multiple times, and "
             "each time adds to the existing value. Accepts either :all: to "
             "disable all source packages, :none: to empty the set, or one or "
             "more package names with commas between them. Packages without "
             "binary distributions will fail to install when this option is "
             "used on them."***REMOVED***


cache_dir = partial(
    Option,
    "--cache-dir",
    dest="cache_dir",
    default=USER_CACHE_DIR,
    metavar="dir",
    help="Store the cache data in <dir>."
***REMOVED***

no_cache = partial(
    Option,
    "--no-cache-dir",
    dest="cache_dir",
    action="store_false",
    help="Disable the cache.",
***REMOVED***

no_deps = partial(
    Option,
    '--no-deps', '--no-dependencies',
    dest='ignore_dependencies',
    action='store_true',
    default=False,
    help="Don't install package dependencies."***REMOVED***

build_dir = partial(
    Option,
    '-b', '--build', '--build-dir', '--build-directory',
    dest='build_dir',
    metavar='dir',
    help='Directory to unpack packages into and build in.'
***REMOVED***

install_options = partial(
    Option,
    '--install-option',
    dest='install_options',
    action='append',
    metavar='options',
    help="Extra arguments to be supplied to the setup.py install "
         "command (use like --install-option=\"--install-scripts=/usr/local/"
         "bin\"***REMOVED***. Use multiple --install-option options to pass multiple "
         "options to setup.py install. If you are using an option with a "
         "directory path, be sure to use absolute path."***REMOVED***

global_options = partial(
    Option,
    '--global-option',
    dest='global_options',
    action='append',
    metavar='options',
    help="Extra global options to be supplied to the setup.py "
         "call before the install command."***REMOVED***

no_clean = partial(
    Option,
    '--no-clean',
    action='store_true',
    default=False,
    help="Don't clean up build directories."***REMOVED***

pre = partial(
    Option,
    '--pre',
    action='store_true',
    default=False,
    help="Include pre-release and development versions. By default, "
         "pip only finds stable versions."***REMOVED***

disable_pip_version_check = partial(
    Option,
    "--disable-pip-version-check",
    dest="disable_pip_version_check",
    action="store_true",
    default=False,
    help="Don't periodically check PyPI to determine whether a new version "
         "of pip is available for download. Implied with --no-index."***REMOVED***

# Deprecated, Remove later
always_unzip = partial(
    Option,
    '-Z', '--always-unzip',
    dest='always_unzip',
    action='store_true',
    help=SUPPRESS_HELP,
***REMOVED***


def _merge_hash(option, opt_str, value, parser***REMOVED***:
    ***REMOVED***Given a value spelled "algo:digest", append the digest to a list
    pointed to in a dict by the algo name.***REMOVED***
    if not parser.values.hashes:
        parser.values.hashes = {***REMOVED***
    ***REMOVED***
        algo, digest = value.split(':', 1***REMOVED***
    except ValueError:
        parser.error('Arguments to %s must be a hash name '
                     'followed by a value, like --hash=sha256:abcde...' %
                     opt_str***REMOVED***
    if algo not in STRONG_HASHES:
        parser.error('Allowed hash algorithms for %s are %s.' %
                     (opt_str, ', '.join(STRONG_HASHES***REMOVED******REMOVED******REMOVED***
    parser.values.hashes.setdefault(algo, [***REMOVED******REMOVED***.append(digest***REMOVED***


hash = partial(
    Option,
    '--hash',
    # Hash values eventually end up in InstallRequirement.hashes due to
    # __dict__ copying in process_line(***REMOVED***.
    dest='hashes',
    action='callback',
    callback=_merge_hash,
    type='string',
    help="Verify that the package's archive matches this "
         'hash before installing. Example: --hash=sha256:abcdef...'***REMOVED***


require_hashes = partial(
    Option,
    '--require-hashes',
    dest='require_hashes',
    action='store_true',
    default=False,
    help='Require a hash to check each requirement against, for '
         'repeatable installs. This option is implied when any package in a '
         'requirements file has a --hash option.'***REMOVED***


##########
# groups #
##########

general_group = {
    'name': 'General Options',
    'options': [
        help_,
        isolated_mode,
        require_virtualenv,
        verbose,
        version,
        quiet,
        log,
        no_input,
        proxy,
        retries,
        timeout,
        default_vcs,
        skip_requirements_regex,
        exists_action,
        trusted_host,
        cert,
        client_cert,
        cache_dir,
        no_cache,
        disable_pip_version_check,
    ***REMOVED***
***REMOVED***

non_deprecated_index_group = {
    'name': 'Package Index Options',
    'options': [
        index_url,
        extra_index_url,
        no_index,
        find_links,
        process_dependency_links,
    ***REMOVED***
***REMOVED***

index_group = {
    'name': 'Package Index Options (including deprecated options***REMOVED***',
    'options': non_deprecated_index_group['options'***REMOVED*** + [
        allow_external,
        allow_all_external,
        no_allow_external,
        allow_unsafe,
        no_allow_unsafe,
    ***REMOVED***
***REMOVED***
