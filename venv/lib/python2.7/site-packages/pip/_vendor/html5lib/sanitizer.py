from __future__ import absolute_import, division, unicode_literals

import re
from xml.sax.saxutils import escape, unescape
from six.moves import urllib_parse as urlparse

from .tokenizer import HTMLTokenizer
from .constants import tokenTypes


content_type_rgx = re.compile(r'''
                               ^
                               # Match a content type <application>/<type>
                               (?P<content_type>[-a-zA-Z0-9.***REMOVED***+/[-a-zA-Z0-9.***REMOVED***+***REMOVED***
                               # Match any character set and encoding
                               (?:(?:;charset=(?:[-a-zA-Z0-9***REMOVED***+***REMOVED***(?:;(?:base64***REMOVED******REMOVED***?***REMOVED***
                                 |(?:;(?:base64***REMOVED******REMOVED***?(?:;charset=(?:[-a-zA-Z0-9***REMOVED***+***REMOVED******REMOVED***?***REMOVED***
                               # Assume the rest is data
                               ,.*
                               $
                               ''',
                              re.VERBOSE***REMOVED***


class HTMLSanitizerMixin(object***REMOVED***:
    ***REMOVED*** sanitization of XHTML+MathML+SVG and of inline style attributes.***REMOVED***

    acceptable_elements = ['a', 'abbr', 'acronym', 'address', 'area',
                           'article', 'aside', 'audio', 'b', 'big', 'blockquote', 'br', 'button',
                           'canvas', 'caption', 'center', 'cite', 'code', 'col', 'colgroup',
                           'command', 'datagrid', 'datalist', 'dd', 'del', 'details', 'dfn',
                           'dialog', 'dir', 'div', 'dl', 'dt', 'em', 'event-source', 'fieldset',
                           'figcaption', 'figure', 'footer', 'font', 'form', 'header', 'h1',
                           'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'img', 'input', 'ins',
                           'keygen', 'kbd', 'label', 'legend', 'li', 'm', 'map', 'menu', 'meter',
                           'multicol', 'nav', 'nextid', 'ol', 'output', 'optgroup', 'option',
                           'p', 'pre', 'progress', 'q', 's', 'samp', 'section', 'select',
                           'small', 'sound', 'source', 'spacer', 'span', 'strike', 'strong',
                           'sub', 'sup', 'table', 'tbody', 'td', 'textarea', 'time', 'tfoot',
                           'th', 'thead', 'tr', 'tt', 'u', 'ul', 'var', 'video'***REMOVED***

    mathml_elements = ['maction', 'math', 'merror', 'mfrac', 'mi',
                       'mmultiscripts', 'mn', 'mo', 'mover', 'mpadded', 'mphantom',
                       'mprescripts', 'mroot', 'mrow', 'mspace', 'msqrt', 'mstyle', 'msub',
                       'msubsup', 'msup', 'mtable', 'mtd', 'mtext', 'mtr', 'munder',
                       'munderover', 'none'***REMOVED***

    svg_elements = ['a', 'animate', 'animateColor', 'animateMotion',
                    'animateTransform', 'clipPath', 'circle', 'defs', 'desc', 'ellipse',
                    'font-face', 'font-face-name', 'font-face-src', 'g', 'glyph', 'hkern',
                    'linearGradient', 'line', 'marker', 'metadata', 'missing-glyph',
                    'mpath', 'path', 'polygon', 'polyline', 'radialGradient', 'rect',
                    'set', 'stop', 'svg', 'switch', 'text', 'title', 'tspan', 'use'***REMOVED***

    acceptable_attributes = ['abbr', 'accept', 'accept-charset', 'accesskey',
                             'action', 'align', 'alt', 'autocomplete', 'autofocus', 'axis',
                             'background', 'balance', 'bgcolor', 'bgproperties', 'border',
                             'bordercolor', 'bordercolordark', 'bordercolorlight', 'bottompadding',
                             'cellpadding', 'cellspacing', 'ch', 'challenge', 'char', 'charoff',
                             'choff', 'charset', 'checked', 'cite', 'class', 'clear', 'color',
                             'cols', 'colspan', 'compact', 'contenteditable', 'controls', 'coords',
                             'data', 'datafld', 'datapagesize', 'datasrc', 'datetime', 'default',
                             'delay', 'dir', 'disabled', 'draggable', 'dynsrc', 'enctype', 'end',
                             'face', 'for', 'form', 'frame', 'galleryimg', 'gutter', 'headers',
                             'height', 'hidefocus', 'hidden', 'high', 'href', 'hreflang', 'hspace',
                             'icon', 'id', 'inputmode', 'ismap', 'keytype', 'label', 'leftspacing',
                             'lang', 'list', 'longdesc', 'loop', 'loopcount', 'loopend',
                             'loopstart', 'low', 'lowsrc', 'max', 'maxlength', 'media', 'method',
                             'min', 'multiple', 'name', 'nohref', 'noshade', 'nowrap', 'open',
                             'optimum', 'pattern', 'ping', 'point-size', 'poster', 'pqg', 'preload',
                             'prompt', 'radiogroup', 'readonly', 'rel', 'repeat-max', 'repeat-min',
                             'replace', 'required', 'rev', 'rightspacing', 'rows', 'rowspan',
                             'rules', 'scope', 'selected', 'shape', 'size', 'span', 'src', 'start',
                             'step', 'style', 'summary', 'suppress', 'tabindex', 'target',
                             'template', 'title', 'toppadding', 'type', 'unselectable', 'usemap',
                             'urn', 'valign', 'value', 'variable', 'volume', 'vspace', 'vrml',
                             'width', 'wrap', 'xml:lang'***REMOVED***

    mathml_attributes = ['actiontype', 'align', 'columnalign', 'columnalign',
                         'columnalign', 'columnlines', 'columnspacing', 'columnspan', 'depth',
                         'display', 'displaystyle', 'equalcolumns', 'equalrows', 'fence',
                         'fontstyle', 'fontweight', 'frame', 'height', 'linethickness', 'lspace',
                         'mathbackground', 'mathcolor', 'mathvariant', 'mathvariant', 'maxsize',
                         'minsize', 'other', 'rowalign', 'rowalign', 'rowalign', 'rowlines',
                         'rowspacing', 'rowspan', 'rspace', 'scriptlevel', 'selection',
                         'separator', 'stretchy', 'width', 'width', 'xlink:href', 'xlink:show',
                         'xlink:type', 'xmlns', 'xmlns:xlink'***REMOVED***

    svg_attributes = ['accent-height', 'accumulate', 'additive', 'alphabetic',
                      'arabic-form', 'ascent', 'attributeName', 'attributeType',
                      'baseProfile', 'bbox', 'begin', 'by', 'calcMode', 'cap-height',
                      'class', 'clip-path', 'color', 'color-rendering', 'content', 'cx',
                      'cy', 'd', 'dx', 'dy', 'descent', 'display', 'dur', 'end', 'fill',
                      'fill-opacity', 'fill-rule', 'font-family', 'font-size',
                      'font-stretch', 'font-style', 'font-variant', 'font-weight', 'from',
                      'fx', 'fy', 'g1', 'g2', 'glyph-name', 'gradientUnits', 'hanging',
                      'height', 'horiz-adv-x', 'horiz-origin-x', 'id', 'ideographic', 'k',
                      'keyPoints', 'keySplines', 'keyTimes', 'lang', 'marker-end',
                      'marker-mid', 'marker-start', 'markerHeight', 'markerUnits',
                      'markerWidth', 'mathematical', 'max', 'min', 'name', 'offset',
                      'opacity', 'orient', 'origin', 'overline-position',
                      'overline-thickness', 'panose-1', 'path', 'pathLength', 'points',
                      'preserveAspectRatio', 'r', 'refX', 'refY', 'repeatCount',
                      'repeatDur', 'requiredExtensions', 'requiredFeatures', 'restart',
                      'rotate', 'rx', 'ry', 'slope', 'stemh', 'stemv', 'stop-color',
                      'stop-opacity', 'strikethrough-position', 'strikethrough-thickness',
                      'stroke', 'stroke-dasharray', 'stroke-dashoffset', 'stroke-linecap',
                      'stroke-linejoin', 'stroke-miterlimit', 'stroke-opacity',
                      'stroke-width', 'systemLanguage', 'target', 'text-anchor', 'to',
                      'transform', 'type', 'u1', 'u2', 'underline-position',
                      'underline-thickness', 'unicode', 'unicode-range', 'units-per-em',
                      'values', 'version', 'viewBox', 'visibility', 'width', 'widths', 'x',
                      'x-height', 'x1', 'x2', 'xlink:actuate', 'xlink:arcrole',
                      'xlink:href', 'xlink:role', 'xlink:show', 'xlink:title', 'xlink:type',
                      'xml:base', 'xml:lang', 'xml:space', 'xmlns', 'xmlns:xlink', 'y',
                      'y1', 'y2', 'zoomAndPan'***REMOVED***

    attr_val_is_uri = ['href', 'src', 'cite', 'action', 'longdesc', 'poster', 'background', 'datasrc',
                       'dynsrc', 'lowsrc', 'ping', 'poster', 'xlink:href', 'xml:base'***REMOVED***

    svg_attr_val_allows_ref = ['clip-path', 'color-profile', 'cursor', 'fill',
                               'filter', 'marker', 'marker-start', 'marker-mid', 'marker-end',
                               'mask', 'stroke'***REMOVED***

    svg_allow_local_href = ['altGlyph', 'animate', 'animateColor',
                            'animateMotion', 'animateTransform', 'cursor', 'feImage', 'filter',
                            'linearGradient', 'pattern', 'radialGradient', 'textpath', 'tref',
                            'set', 'use'***REMOVED***

    acceptable_css_properties = ['azimuth', 'background-color',
                                 'border-bottom-color', 'border-collapse', 'border-color',
                                 'border-left-color', 'border-right-color', 'border-top-color', 'clear',
                                 'color', 'cursor', 'direction', 'display', 'elevation', 'float', 'font',
                                 'font-family', 'font-size', 'font-style', 'font-variant', 'font-weight',
                                 'height', 'letter-spacing', 'line-height', 'overflow', 'pause',
                                 'pause-after', 'pause-before', 'pitch', 'pitch-range', 'richness',
                                 'speak', 'speak-header', 'speak-numeral', 'speak-punctuation',
                                 'speech-rate', 'stress', 'text-align', 'text-decoration', 'text-indent',
                                 'unicode-bidi', 'vertical-align', 'voice-family', 'volume',
                                 'white-space', 'width'***REMOVED***

    acceptable_css_keywords = ['auto', 'aqua', 'black', 'block', 'blue',
                               'bold', 'both', 'bottom', 'brown', 'center', 'collapse', 'dashed',
                               'dotted', 'fuchsia', 'gray', 'green', '!important', 'italic', 'left',
                               'lime', 'maroon', 'medium', 'none', 'navy', 'normal', 'nowrap', 'olive',
                               'pointer', 'purple', 'red', 'right', 'solid', 'silver', 'teal', 'top',
                               'transparent', 'underline', 'white', 'yellow'***REMOVED***

    acceptable_svg_properties = ['fill', 'fill-opacity', 'fill-rule',
                                 'stroke', 'stroke-width', 'stroke-linecap', 'stroke-linejoin',
                                 'stroke-opacity'***REMOVED***

    acceptable_protocols = ['ed2k', 'ftp', 'http', 'https', 'irc',
                            'mailto', 'news', 'gopher', 'nntp', 'telnet', 'webcal',
                            'xmpp', 'callto', 'feed', 'urn', 'aim', 'rsync', 'tag',
                            'ssh', 'sftp', 'rtsp', 'afs', 'data'***REMOVED***

    acceptable_content_types = ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'image/bmp', 'text/plain'***REMOVED***

    # subclasses may define their own versions of these constants
    allowed_elements = acceptable_elements + mathml_elements + svg_elements
    allowed_attributes = acceptable_attributes + mathml_attributes + svg_attributes
    allowed_css_properties = acceptable_css_properties
    allowed_css_keywords = acceptable_css_keywords
    allowed_svg_properties = acceptable_svg_properties
    allowed_protocols = acceptable_protocols
    allowed_content_types = acceptable_content_types

    # Sanitize the +html+, escaping all elements not in ALLOWED_ELEMENTS, and
    # stripping out all # attributes not in ALLOWED_ATTRIBUTES. Style
    # attributes are parsed, and a restricted set, # specified by
    # ALLOWED_CSS_PROPERTIES and ALLOWED_CSS_KEYWORDS, are allowed through.
    # attributes in ATTR_VAL_IS_URI are scanned, and only URI schemes specified
    # in ALLOWED_PROTOCOLS are allowed.
    #
    #   sanitize_html('<script> do_nasty_stuff(***REMOVED*** </script>'***REMOVED***
    #    => &lt;script> do_nasty_stuff(***REMOVED*** &lt;/script>
    #   sanitize_html('<a href="javascript: sucker(***REMOVED***;">Click here for $100</a>'***REMOVED***
    #    => <a>Click here for $100</a>
    def sanitize_token(self, token***REMOVED***:

        # accommodate filters which use token_type differently
        token_type = token["type"***REMOVED***
        if token_type in list(tokenTypes.keys(***REMOVED******REMOVED***:
            token_type = tokenTypes[token_type***REMOVED***

        if token_type in (tokenTypes["StartTag"***REMOVED***, tokenTypes["EndTag"***REMOVED***,
                          tokenTypes["EmptyTag"***REMOVED******REMOVED***:
            if token["name"***REMOVED*** in self.allowed_elements:
                return self.allowed_token(token, token_type***REMOVED***
            else:
                return self.disallowed_token(token, token_type***REMOVED***
        elif token_type == tokenTypes["Comment"***REMOVED***:
            pass
        else:
            return token

    def allowed_token(self, token, token_type***REMOVED***:
        if "data" in token:
            attrs = dict([(name, val***REMOVED*** for name, val in
                          token["data"***REMOVED***[::-1***REMOVED***
                          if name in self.allowed_attributes***REMOVED******REMOVED***
            for attr in self.attr_val_is_uri:
                if attr not in attrs:
                    continue
                val_unescaped = re.sub("[`\000-\040\177-\240\s***REMOVED***+", '',
                                       unescape(attrs[attr***REMOVED******REMOVED******REMOVED***.lower(***REMOVED***
                # remove replacement characters from unescaped characters
                val_unescaped = val_unescaped.replace("\ufffd", ""***REMOVED***
                ***REMOVED***
                    uri = urlparse.urlparse(val_unescaped***REMOVED***
                except ValueError:
                    uri = None
                    del attrs[attr***REMOVED***
                if uri and uri.scheme:
                    if uri.scheme not in self.allowed_protocols:
                        del attrs[attr***REMOVED***
                    if uri.scheme == 'data':
                        m = content_type_rgx.match(uri.path***REMOVED***
                        if not m:
                            del attrs[attr***REMOVED***
                        elif m.group('content_type'***REMOVED*** not in self.allowed_content_types:
                            del attrs[attr***REMOVED***

            for attr in self.svg_attr_val_allows_ref:
                if attr in attrs:
                    attrs[attr***REMOVED*** = re.sub(r'url\s*\(\s*[^#\s***REMOVED***[^***REMOVED******REMOVED***+?\***REMOVED***',
                                         ' ',
                                         unescape(attrs[attr***REMOVED******REMOVED******REMOVED***
            if (token["name"***REMOVED*** in self.svg_allow_local_href and
                'xlink:href' in attrs and re.search('^\s*[^#\s***REMOVED***.*',
                                                    attrs['xlink:href'***REMOVED******REMOVED******REMOVED***:
                del attrs['xlink:href'***REMOVED***
            if 'style' in attrs:
                attrs['style'***REMOVED*** = self.sanitize_css(attrs['style'***REMOVED******REMOVED***
            token["data"***REMOVED*** = [[name, val***REMOVED*** for name, val in list(attrs.items(***REMOVED******REMOVED******REMOVED***
        return token

    def disallowed_token(self, token, token_type***REMOVED***:
        if token_type == tokenTypes["EndTag"***REMOVED***:
            token["data"***REMOVED*** = "</%s>" % token["name"***REMOVED***
        elif token["data"***REMOVED***:
            attrs = ''.join([' %s="%s"' % (k, escape(v***REMOVED******REMOVED*** for k, v in token["data"***REMOVED******REMOVED******REMOVED***
            token["data"***REMOVED*** = "<%s%s>" % (token["name"***REMOVED***, attrs***REMOVED***
        else:
            token["data"***REMOVED*** = "<%s>" % token["name"***REMOVED***
        if token.get("selfClosing"***REMOVED***:
            token["data"***REMOVED*** = token["data"***REMOVED***[:-1***REMOVED*** + "/>"

        if token["type"***REMOVED*** in list(tokenTypes.keys(***REMOVED******REMOVED***:
            token["type"***REMOVED*** = "Characters"
        else:
            token["type"***REMOVED*** = tokenTypes["Characters"***REMOVED***

        del token["name"***REMOVED***
        return token

    def sanitize_css(self, style***REMOVED***:
        # disallow urls
        style = re.compile('url\s*\(\s*[^\s***REMOVED******REMOVED***+?\s*\***REMOVED***\s*'***REMOVED***.sub(' ', style***REMOVED***

        # gauntlet
        if not re.match(***REMOVED***^([:,;#%.\sa-zA-Z0-9!***REMOVED***|\w-\w|'[\s\w***REMOVED***+'|"[\s\w***REMOVED***+"|\([\d,\s***REMOVED***+\***REMOVED******REMOVED****$***REMOVED***, style***REMOVED***:
            return ''
        if not re.match("^\s*([-\w***REMOVED***+\s*:[^:;***REMOVED****(;\s*|$***REMOVED******REMOVED****$", style***REMOVED***:
            return ''

        clean = [***REMOVED***
        for prop, value in re.findall("([-\w***REMOVED***+***REMOVED***\s*:\s*([^:;***REMOVED*******REMOVED***", style***REMOVED***:
            if not value:
                continue
            if prop.lower(***REMOVED*** in self.allowed_css_properties:
                clean.append(prop + ': ' + value + ';'***REMOVED***
            elif prop.split('-'***REMOVED***[0***REMOVED***.lower(***REMOVED*** in ['background', 'border', 'margin',
                                                'padding'***REMOVED***:
                for keyword in value.split(***REMOVED***:
                    if keyword not in self.acceptable_css_keywords and \
                            not re.match("^(#[0-9a-f***REMOVED***+|rgb\(\d+%?,\d*%?,?\d*%?\***REMOVED***?|\d{0,2***REMOVED***\.?\d{0,2***REMOVED***(cm|em|ex|in|mm|pc|pt|px|%|,|\***REMOVED******REMOVED***?***REMOVED***$", keyword***REMOVED***:
                        break
                else:
                    clean.append(prop + ': ' + value + ';'***REMOVED***
            elif prop.lower(***REMOVED*** in self.allowed_svg_properties:
                clean.append(prop + ': ' + value + ';'***REMOVED***

        return ' '.join(clean***REMOVED***


class HTMLSanitizer(HTMLTokenizer, HTMLSanitizerMixin***REMOVED***:
    def __init__(self, stream, encoding=None, parseMeta=True, useChardet=True,
                 lowercaseElementName=False, lowercaseAttrName=False, parser=None***REMOVED***:
        # Change case matching defaults as we only output lowercase html anyway
        # This solution doesn't seem ideal...
        HTMLTokenizer.__init__(self, stream, encoding, parseMeta, useChardet,
                               lowercaseElementName, lowercaseAttrName, parser=parser***REMOVED***

    def __iter__(self***REMOVED***:
        for token in HTMLTokenizer.__iter__(self***REMOVED***:
            token = self.sanitize_token(token***REMOVED***
            if token:
                yield token
