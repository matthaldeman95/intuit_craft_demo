***REMOVED***The match_hostname(***REMOVED*** function from Python 3.3.3, essential when using SSL.***REMOVED***

# Note: This file is under the PSF license as the code comes from the python
# stdlib.   http://docs.python.org/3/license.html

import re

__version__ = '3.4.0.2'

class CertificateError(ValueError***REMOVED***:
    pass


def _dnsname_match(dn, hostname, max_wildcards=1***REMOVED***:
    ***REMOVED***Matching according to RFC 6125, section 6.4.3

    http://tools.ietf.org/html/rfc6125#section-6.4.3
    ***REMOVED***
    pats = [***REMOVED***
    if not dn:
        return False

    # Ported from python3-syntax:
    # leftmost, *remainder = dn.split(r'.'***REMOVED***
    parts = dn.split(r'.'***REMOVED***
    leftmost = parts[0***REMOVED***
    remainder = parts[1:***REMOVED***

    wildcards = leftmost.count('*'***REMOVED***
    if wildcards > max_wildcards:
        # Issue #17980: avoid denials of service by refusing more
        # than one wildcard per fragment.  A survey of established
        # policy among SSL implementations showed it to be a
        # reasonable choice.
        raise CertificateError(
            "too many wildcards in certificate DNS name: " + repr(dn***REMOVED******REMOVED***

    # speed up common case w/o wildcards
    if not wildcards:
        return dn.lower(***REMOVED*** == hostname.lower(***REMOVED***

    # RFC 6125, section 6.4.3, subitem 1.
    # The client SHOULD NOT attempt to match a presented identifier in which
    # the wildcard character comprises a label other than the left-most label.
    if leftmost == '*':
        # When '*' is a fragment by itself, it matches a non-empty dotless
        # fragment.
        pats.append('[^.***REMOVED***+'***REMOVED***
    elif leftmost.startswith('xn--'***REMOVED*** or hostname.startswith('xn--'***REMOVED***:
        # RFC 6125, section 6.4.3, subitem 3.
        # The client SHOULD NOT attempt to match a presented identifier
        # where the wildcard character is embedded within an A-label or
        # U-label of an internationalized domain name.
        pats.append(re.escape(leftmost***REMOVED******REMOVED***
    else:
        # Otherwise, '*' matches any dotless string, e.g. www*
        pats.append(re.escape(leftmost***REMOVED***.replace(r'\*', '[^.***REMOVED****'***REMOVED******REMOVED***

    # add the remaining fragments, ignore any wildcards
    for frag in remainder:
        pats.append(re.escape(frag***REMOVED******REMOVED***

    pat = re.compile(r'\A' + r'\.'.join(pats***REMOVED*** + r'\Z', re.IGNORECASE***REMOVED***
    return pat.match(hostname***REMOVED***


def match_hostname(cert, hostname***REMOVED***:
    ***REMOVED***Verify that *cert* (in decoded format as returned by
    SSLSocket.getpeercert(***REMOVED******REMOVED*** matches the *hostname*.  RFC 2818 and RFC 6125
    rules are followed, but IP addresses are not accepted for *hostname*.

    CertificateError is raised on failure. On success, the function
    returns nothing.
    ***REMOVED***
    if not cert:
        raise ValueError("empty or no certificate"***REMOVED***
    dnsnames = [***REMOVED***
    san = cert.get('subjectAltName', (***REMOVED******REMOVED***
    for key, value in san:
        if key == 'DNS':
            if _dnsname_match(value, hostname***REMOVED***:
                return
            dnsnames.append(value***REMOVED***
    if not dnsnames:
        # The subject is only checked when there is no dNSName entry
        # in subjectAltName
        for sub in cert.get('subject', (***REMOVED******REMOVED***:
            for key, value in sub:
                # XXX according to RFC 2818, the most specific Common Name
                # must be used.
                if key == 'commonName':
                    if _dnsname_match(value, hostname***REMOVED***:
                        return
                    dnsnames.append(value***REMOVED***
    if len(dnsnames***REMOVED*** > 1:
        raise CertificateError("hostname %r "
            "doesn't match either of %s"
            % (hostname, ', '.join(map(repr, dnsnames***REMOVED******REMOVED******REMOVED******REMOVED***
    elif len(dnsnames***REMOVED*** == 1:
        raise CertificateError("hostname %r "
            "doesn't match %r"
            % (hostname, dnsnames[0***REMOVED******REMOVED******REMOVED***
    else:
        raise CertificateError("no appropriate commonName or "
            "subjectAltName fields were found"***REMOVED***
