import distutils.command.bdist_rpm as orig


class bdist_rpm(orig.bdist_rpm***REMOVED***:
    ***REMOVED***
    Override the default bdist_rpm behavior to do the following:

    1. Run egg_info to ensure the name and version are properly calculated.
    2. Always run 'install' using --single-version-externally-managed to
       disable eggs in RPM distributions.
    3. Replace dash with underscore in the version numbers for better RPM
       compatibility.
    ***REMOVED***

    def run(self***REMOVED***:
        # ensure distro name is up-to-date
        self.run_command('egg_info'***REMOVED***

        orig.bdist_rpm.run(self***REMOVED***

    def _make_spec_file(self***REMOVED***:
        version = self.distribution.get_version(***REMOVED***
        rpmversion = version.replace('-', '_'***REMOVED***
        spec = orig.bdist_rpm._make_spec_file(self***REMOVED***
        line23 = '%define version ' + version
        line24 = '%define version ' + rpmversion
        spec = [
            line.replace(
                "Source0: %{name***REMOVED***-%{version***REMOVED***.tar",
                "Source0: %{name***REMOVED***-%{unmangled_version***REMOVED***.tar"
            ***REMOVED***.replace(
                "setup.py install ",
                "setup.py install --single-version-externally-managed "
            ***REMOVED***.replace(
                "%setup",
                "%setup -n %{name***REMOVED***-%{unmangled_version***REMOVED***"
            ***REMOVED***.replace(line23, line24***REMOVED***
            for line in spec
        ***REMOVED***
        insert_loc = spec.index(line24***REMOVED*** + 1
        unmangled_version = "%define unmangled_version " + version
        spec.insert(insert_loc, unmangled_version***REMOVED***
        return spec
