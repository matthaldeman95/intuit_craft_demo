
# http://www.absoft.com/literature/osxuserguide.pdf
# http://www.absoft.com/documentation.html

# Notes:
# - when using -g77 then use -DUNDERSCORE_G77 to compile f2py
#   generated extension modules (works for f2py v2.45.241_1936 and up***REMOVED***
from __future__ import division, absolute_import, print_function

***REMOVED***

from numpy.distutils.cpuinfo import cpu
from numpy.distutils.fcompiler import FCompiler, dummy_fortran_file
from numpy.distutils.misc_util import cyg2win32

compilers = ['AbsoftFCompiler'***REMOVED***

class AbsoftFCompiler(FCompiler***REMOVED***:

    compiler_type = 'absoft'
    description = 'Absoft Corp Fortran Compiler'
    #version_pattern = r'FORTRAN 77 Compiler (?P<version>[^\s*,***REMOVED*******REMOVED***.*?Absoft Corp'
    version_pattern = r'(f90:.*?(Absoft Pro FORTRAN Version|FORTRAN 77 Compiler|Absoft Fortran Compiler Version|Copyright Absoft Corporation.*?Version***REMOVED******REMOVED***'+\
                       r' (?P<version>[^\s*,***REMOVED*******REMOVED***(.*?Absoft Corp|***REMOVED***'

    # on windows: f90 -V -c dummy.f
    # f90: Copyright Absoft Corporation 1994-1998 mV2; Cray Research, Inc. 1994-1996 CF90 (2.x.x.x  f36t87***REMOVED*** Version 2.3 Wed Apr 19, 2006  13:05:16

    # samt5735(8***REMOVED***$ f90 -V -c dummy.f
    # f90: Copyright Absoft Corporation 1994-2002; Absoft Pro FORTRAN Version 8.0
    # Note that fink installs g77 as f77, so need to use f90 for detection.

    executables = {
        'version_cmd'  : None,          # set by update_executables
        'compiler_f77' : ["f77"***REMOVED***,
        'compiler_fix' : ["f90"***REMOVED***,
        'compiler_f90' : ["f90"***REMOVED***,
        'linker_so'    : ["<F90>"***REMOVED***,
        'archiver'     : ["ar", "-cr"***REMOVED***,
        'ranlib'       : ["ranlib"***REMOVED***
    ***REMOVED***

    if os.name=='nt':
        library_switch = '/out:'      #No space after /out:!

    module_dir_switch = None
    module_include_switch = '-p'

    def update_executables(self***REMOVED***:
        f = cyg2win32(dummy_fortran_file(***REMOVED******REMOVED***
        self.executables['version_cmd'***REMOVED*** = ['<F90>', '-V', '-c',
                                           f+'.f', '-o', f+'.o'***REMOVED***

    def get_flags_linker_so(self***REMOVED***:
        if os.name=='nt':
            opt = ['/dll'***REMOVED***
        # The "-K shared" switches are being left in for pre-9.0 versions
        # of Absoft though I don't think versions earlier than 9 can
        # actually be used to build shared libraries.  In fact, version
        # 8 of Absoft doesn't recognize "-K shared" and will fail.
        elif self.get_version(***REMOVED*** >= '9.0':
            opt = ['-shared'***REMOVED***
        else:
            opt = ["-K", "shared"***REMOVED***
        return opt

    def library_dir_option(self, dir***REMOVED***:
        if os.name=='nt':
            return ['-link', '/PATH:"%s"' % (dir***REMOVED******REMOVED***
        return "-L" + dir

    def library_option(self, lib***REMOVED***:
        if os.name=='nt':
            return '%s.lib' % (lib***REMOVED***
        return "-l" + lib

    def get_library_dirs(self***REMOVED***:
        opt = FCompiler.get_library_dirs(self***REMOVED***
        d = os.environ.get('ABSOFT'***REMOVED***
        if d:
            if self.get_version(***REMOVED*** >= '10.0':
                # use shared libraries, the static libraries were not compiled -fPIC
                prefix = 'sh'
            else:
                prefix = ''
            if cpu.is_64bit(***REMOVED***:
                suffix = '64'
            else:
                suffix = ''
            opt.append(os.path.join(d, '%slib%s' % (prefix, suffix***REMOVED******REMOVED******REMOVED***
        return opt

    def get_libraries(self***REMOVED***:
        opt = FCompiler.get_libraries(self***REMOVED***
        if self.get_version(***REMOVED*** >= '11.0':
            opt.extend(['af90math', 'afio', 'af77math', 'amisc'***REMOVED******REMOVED***
        elif self.get_version(***REMOVED*** >= '10.0':
            opt.extend(['af90math', 'afio', 'af77math', 'U77'***REMOVED******REMOVED***
        elif self.get_version(***REMOVED*** >= '8.0':
            opt.extend(['f90math', 'fio', 'f77math', 'U77'***REMOVED******REMOVED***
        else:
            opt.extend(['fio', 'f90math', 'fmath', 'U77'***REMOVED******REMOVED***
        if os.name =='nt':
            opt.append('COMDLG32'***REMOVED***
        return opt

    def get_flags(self***REMOVED***:
        opt = FCompiler.get_flags(self***REMOVED***
        if os.name != 'nt':
            opt.extend(['-s'***REMOVED******REMOVED***
            if self.get_version(***REMOVED***:
                if self.get_version(***REMOVED***>='8.2':
                    opt.append('-fpic'***REMOVED***
        return opt

    def get_flags_f77(self***REMOVED***:
        opt = FCompiler.get_flags_f77(self***REMOVED***
        opt.extend(['-N22', '-N90', '-N110'***REMOVED******REMOVED***
        v = self.get_version(***REMOVED***
        if os.name == 'nt':
            if v and v>='8.0':
                opt.extend(['-f', '-N15'***REMOVED******REMOVED***
        else:
            opt.append('-f'***REMOVED***
            if v:
                if v<='4.6':
                    opt.append('-B108'***REMOVED***
                else:
                    # Though -N15 is undocumented, it works with
                    # Absoft 8.0 on Linux
                    opt.append('-N15'***REMOVED***
        return opt

    def get_flags_f90(self***REMOVED***:
        opt = FCompiler.get_flags_f90(self***REMOVED***
        opt.extend(["-YCFRL=1", "-YCOM_NAMES=LCS", "-YCOM_PFX", "-YEXT_PFX",
                    "-YCOM_SFX=_", "-YEXT_SFX=_", "-YEXT_NAMES=LCS"***REMOVED******REMOVED***
        if self.get_version(***REMOVED***:
            if self.get_version(***REMOVED***>'4.6':
                opt.extend(["-YDEALLOC=ALL"***REMOVED******REMOVED***
        return opt

    def get_flags_fix(self***REMOVED***:
        opt = FCompiler.get_flags_fix(self***REMOVED***
        opt.extend(["-YCFRL=1", "-YCOM_NAMES=LCS", "-YCOM_PFX", "-YEXT_PFX",
                    "-YCOM_SFX=_", "-YEXT_SFX=_", "-YEXT_NAMES=LCS"***REMOVED******REMOVED***
        opt.extend(["-f", "fixed"***REMOVED******REMOVED***
        return opt

    def get_flags_opt(self***REMOVED***:
        opt = ['-O'***REMOVED***
        return opt

if __name__ == '__main__':
    from distutils import log
    log.set_verbosity(2***REMOVED***
    from numpy.distutils.fcompiler import new_fcompiler
    compiler = new_fcompiler(compiler='absoft'***REMOVED***
    compiler.customize(***REMOVED***
    print(compiler.get_version(***REMOVED******REMOVED***
