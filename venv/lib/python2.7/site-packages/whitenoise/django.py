from __future__ import absolute_import

***REMOVED***

from django.conf import settings
from django.core.exceptions import ImproperlyConfigured
***REMOVED***
    from django.contrib.staticfiles.storage import staticfiles_storage
except ImproperlyConfigured:
    if not os.environ.get('DJANGO_SETTINGS_MODULE'***REMOVED***:
        raise ImproperlyConfigured(
                "'DJANGO_SETTINGS_MODULE' environment variable must be set "
                "before importing 'whitenoise.django'"***REMOVED***
    else:
        raise
from django.contrib.staticfiles import finders
from django.utils.six.moves.urllib.parse import urlparse

from .base import WhiteNoise
# Import here under an alias for backwards compatibility
from .storage import (CompressedManifestStaticFilesStorage as
                      GzipManifestStaticFilesStorage***REMOVED***
from .utils import (decode_if_byte_string, ensure_leading_trailing_slash,
                    IsDirectoryError***REMOVED***


__all__ = ['DjangoWhiteNoise', 'GzipManifestStaticFilesStorage'***REMOVED***


class DjangoWhiteNoise(WhiteNoise***REMOVED***:

    config_attrs = WhiteNoise.config_attrs + (
            'root', 'use_finders', 'static_prefix'***REMOVED***
    root = None
    use_finders = False
    static_prefix = None

    def __init__(self, application, settings=settings***REMOVED***:
        self.configure_from_settings(settings***REMOVED***
        self.check_settings(settings***REMOVED***
        super(DjangoWhiteNoise, self***REMOVED***.__init__(application***REMOVED***
        if self.static_root:
            self.add_files(self.static_root, prefix=self.static_prefix***REMOVED***
        if self.root:
            self.add_files(self.root***REMOVED***

    def configure_from_settings(self, settings***REMOVED***:
        # Default configuration
        self.charset = settings.FILE_CHARSET
        self.autorefresh = settings.DEBUG
        self.use_finders = settings.DEBUG
        self.static_prefix = urlparse(settings.STATIC_URL or ''***REMOVED***.path
        if settings.DEBUG:
            self.max_age = 0
        # Allow settings to override default attributes
        for attr in self.config_attrs:
            settings_key = 'WHITENOISE_{0***REMOVED***'.format(attr.upper(***REMOVED******REMOVED***
            ***REMOVED***
                value = getattr(settings, settings_key***REMOVED***
            except AttributeError:
                pass
            else:
                value = decode_if_byte_string(value***REMOVED***
                setattr(self, attr, value***REMOVED***
        self.static_prefix = ensure_leading_trailing_slash(self.static_prefix***REMOVED***
        self.static_root = decode_if_byte_string(settings.STATIC_ROOT***REMOVED***

    def check_settings(self, settings***REMOVED***:
        if self.use_finders and not self.autorefresh:
            raise ImproperlyConfigured(
                'WHITENOISE_USE_FINDERS can only be enabled in development '
                'when WHITENOISE_AUTOREFRESH is also enabled.'
            ***REMOVED***

    def find_file(self, url***REMOVED***:
        if self.use_finders and url.startswith(self.static_prefix***REMOVED***:
            path = finders.find(url[len(self.static_prefix***REMOVED***:***REMOVED******REMOVED***
            if path:
                ***REMOVED***
                    return self.get_static_file(path, url***REMOVED***
                except IsDirectoryError:
                    return None
        return super(DjangoWhiteNoise, self***REMOVED***.find_file(url***REMOVED***

    def is_immutable_file(self, path, url***REMOVED***:
        ***REMOVED***
        Determine whether given URL represents an immutable file (i.e. a
        file with a hash of its contents as part of its name***REMOVED*** which can
        therefore be cached forever
        ***REMOVED***
        if not url.startswith(self.static_prefix***REMOVED***:
            return False
        name = url[len(self.static_prefix***REMOVED***:***REMOVED***
        name_without_hash = self.get_name_without_hash(name***REMOVED***
        if name == name_without_hash:
            return False
        static_url = self.get_static_url(name_without_hash***REMOVED***
        # If the static URL function maps the name without hash
        # back to the original URL, then we know we've got a
        # versioned filename
        if static_url and static_url.endswith(url***REMOVED***:
            return True
        return False

    def get_name_without_hash(self, filename***REMOVED***:
        ***REMOVED***
        Removes the version hash from a filename e.g, transforms
        'css/application.f3ea4bcc2.css' into 'css/application.css'

        Note: this is specific to the naming scheme used by Django's
        CachedStaticFilesStorage. You may have to override this if
        you are using a different static files versioning system
        ***REMOVED***
        name_with_hash, ext = os.path.splitext(filename***REMOVED***
        name = os.path.splitext(name_with_hash***REMOVED***[0***REMOVED***
        return name + ext

    def get_static_url(self, name***REMOVED***:
        ***REMOVED***
            return decode_if_byte_string(staticfiles_storage.url(name***REMOVED******REMOVED***
        except ValueError:
            return None
