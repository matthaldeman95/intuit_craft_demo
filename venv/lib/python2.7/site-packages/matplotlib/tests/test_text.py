from __future__ import (absolute_import, division, print_function,
                        unicode_literals***REMOVED***

from matplotlib.externals import six
import warnings

import numpy as np
from numpy.testing import assert_almost_equal
from nose.tools import eq_, assert_raises
from nose.plugins.skip import SkipTest

from matplotlib.transforms import Bbox
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.testing.decorators import image_comparison, cleanup
from matplotlib.figure import Figure
from matplotlib.text import Annotation, Text
from matplotlib.backends.backend_agg import RendererAgg


@image_comparison(baseline_images=['font_styles'***REMOVED******REMOVED***
def test_font_styles(***REMOVED***:
    from matplotlib import _get_data_path
    data_path = _get_data_path(***REMOVED***

    def find_matplotlib_font(**kw***REMOVED***:
        prop = FontProperties(**kw***REMOVED***
        path = findfont(prop, directory=data_path***REMOVED***
        return FontProperties(fname=path***REMOVED***

    from matplotlib.font_manager import FontProperties, findfont
    warnings.filterwarnings(
        'ignore',
        ('findfont: Font family \[u?\'Foo\'\***REMOVED*** not found. Falling back to .'***REMOVED***,
        UserWarning,
        module='matplotlib.font_manager'***REMOVED***

    plt.figure(***REMOVED***
    ax = plt.subplot(1, 1, 1***REMOVED***

    normalFont = find_matplotlib_font(
        family="sans-serif",
        style="normal",
        variant="normal",
        size=14***REMOVED***
    ax.annotate(
        "Normal Font",
        (0.1, 0.1***REMOVED***,
        xycoords='axes fraction',
        fontproperties=normalFont***REMOVED***

    boldFont = find_matplotlib_font(
        family="Foo",
        style="normal",
        variant="normal",
        weight="bold",
        stretch=500,
        size=14***REMOVED***
    ax.annotate(
        "Bold Font",
        (0.1, 0.2***REMOVED***,
        xycoords='axes fraction',
        fontproperties=boldFont***REMOVED***

    boldItemFont = find_matplotlib_font(
        family="sans serif",
        style="italic",
        variant="normal",
        weight=750,
        stretch=500,
        size=14***REMOVED***
    ax.annotate(
        "Bold Italic Font",
        (0.1, 0.3***REMOVED***,
        xycoords='axes fraction',
        fontproperties=boldItemFont***REMOVED***

    lightFont = find_matplotlib_font(
        family="sans-serif",
        style="normal",
        variant="normal",
        weight=200,
        stretch=500,
        size=14***REMOVED***
    ax.annotate(
        "Light Font",
        (0.1, 0.4***REMOVED***,
        xycoords='axes fraction',
        fontproperties=lightFont***REMOVED***

    condensedFont = find_matplotlib_font(
        family="sans-serif",
        style="normal",
        variant="normal",
        weight=500,
        stretch=100,
        size=14***REMOVED***
    ax.annotate(
        "Condensed Font",
        (0.1, 0.5***REMOVED***,
        xycoords='axes fraction',
        fontproperties=condensedFont***REMOVED***

    ax.set_xticks([***REMOVED******REMOVED***
    ax.set_yticks([***REMOVED******REMOVED***


@image_comparison(baseline_images=['multiline'***REMOVED******REMOVED***
def test_multiline(***REMOVED***:
    plt.figure(***REMOVED***
    ax = plt.subplot(1, 1, 1***REMOVED***
    ax.set_title("multiline\ntext alignment"***REMOVED***

    plt.text(
        0.2, 0.5, "TpTpTp\n$M$\nTpTpTp", size=20, ha="center", va="top"***REMOVED***

    plt.text(
        0.5, 0.5, "TpTpTp\n$M^{M^{M^{M***REMOVED******REMOVED******REMOVED***$\nTpTpTp", size=20,
        ha="center", va="top"***REMOVED***

    plt.text(
        0.8, 0.5, "TpTpTp\n$M_{q_{q_{q***REMOVED******REMOVED******REMOVED***$\nTpTpTp", size=20,
        ha="center", va="top"***REMOVED***

    plt.xlim(0, 1***REMOVED***
    plt.ylim(0, 0.8***REMOVED***

    ax.set_xticks([***REMOVED******REMOVED***
    ax.set_yticks([***REMOVED******REMOVED***


@image_comparison(baseline_images=['antialiased'***REMOVED***, extensions=['png'***REMOVED******REMOVED***
def test_antialiasing(***REMOVED***:
    matplotlib.rcParams['text.antialiased'***REMOVED*** = True

    fig = plt.figure(figsize=(5.25, 0.75***REMOVED******REMOVED***
    fig.text(0.5, 0.75, "antialiased", horizontalalignment='center',
             verticalalignment='center'***REMOVED***
    fig.text(0.5, 0.25, "$\sqrt{x***REMOVED***$", horizontalalignment='center',
             verticalalignment='center'***REMOVED***
    # NOTE: We don't need to restore the rcParams here, because the
    # test cleanup will do it for us.  In fact, if we do it here, it
    # will turn antialiasing back off before the images are actually
    # rendered.


def test_afm_kerning(***REMOVED***:
    from matplotlib.afm import AFM
    from matplotlib.font_manager import findfont

    fn = findfont("Helvetica", fontext="afm"***REMOVED***
    with open(fn, 'rb'***REMOVED*** as fh:
        afm = AFM(fh***REMOVED***
    assert afm.string_width_height('VAVAVAVAVAVA'***REMOVED*** == (7174.0, 718***REMOVED***


@image_comparison(baseline_images=['text_contains'***REMOVED***, extensions=['png'***REMOVED******REMOVED***
def test_contains(***REMOVED***:
    import matplotlib.backend_bases as mbackend

    fig = plt.figure(***REMOVED***
    ax = plt.axes(***REMOVED***

    mevent = mbackend.MouseEvent(
        'button_press_event', fig.canvas, 0.5, 0.5, 1, None***REMOVED***

    xs = np.linspace(0.25, 0.75, 30***REMOVED***
    ys = np.linspace(0.25, 0.75, 30***REMOVED***
    xs, ys = np.meshgrid(xs, ys***REMOVED***

    txt = plt.text(
        0.48, 0.52, 'hello world', ha='center', fontsize=30, rotation=30***REMOVED***
    # uncomment to draw the text's bounding box
    # txt.set_bbox(dict(edgecolor='black', facecolor='none'***REMOVED******REMOVED***

    # draw the text. This is important, as the contains method can only work
    # when a renderer exists.
    plt.draw(***REMOVED***

    for x, y in zip(xs.flat, ys.flat***REMOVED***:
        mevent.x, mevent.y = plt.gca(***REMOVED***.transAxes.transform_point([x, y***REMOVED******REMOVED***
        contains, _ = txt.contains(mevent***REMOVED***
        color = 'yellow' if contains else 'red'

        # capture the viewLim, plot a point, and reset the viewLim
        vl = ax.viewLim.frozen(***REMOVED***
        ax.plot(x, y, 'o', color=color***REMOVED***
        ax.viewLim.set(vl***REMOVED***


@image_comparison(baseline_images=['titles'***REMOVED******REMOVED***
def test_titles(***REMOVED***:
    # left and right side titles
    plt.figure(***REMOVED***
    ax = plt.subplot(1, 1, 1***REMOVED***
    ax.set_title("left title", loc="left"***REMOVED***
    ax.set_title("right title", loc="right"***REMOVED***
    ax.set_xticks([***REMOVED******REMOVED***
    ax.set_yticks([***REMOVED******REMOVED***


@image_comparison(baseline_images=['text_alignment'***REMOVED******REMOVED***
def test_alignment(***REMOVED***:
    plt.figure(***REMOVED***
    ax = plt.subplot(1, 1, 1***REMOVED***

    x = 0.1
    for rotation in (0, 30***REMOVED***:
        for alignment in ('top', 'bottom', 'baseline', 'center'***REMOVED***:
            ax.text(
                x, 0.5, alignment + " Tj", va=alignment, rotation=rotation,
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5***REMOVED******REMOVED***
            ax.text(
                x, 1.0, r'$\sum_{i=0***REMOVED***^{j***REMOVED***$', va=alignment, rotation=rotation***REMOVED***
            x += 0.1

    ax.plot([0, 1***REMOVED***, [0.5, 0.5***REMOVED******REMOVED***
    ax.plot([0, 1***REMOVED***, [1.0, 1.0***REMOVED******REMOVED***

    ax.set_xlim([0, 1***REMOVED******REMOVED***
    ax.set_ylim([0, 1.5***REMOVED******REMOVED***
    ax.set_xticks([***REMOVED******REMOVED***
    ax.set_yticks([***REMOVED******REMOVED***


@image_comparison(baseline_images=['axes_titles'***REMOVED***, extensions=['png'***REMOVED******REMOVED***
def test_axes_titles(***REMOVED***:
    # Related to issue #3327
    plt.figure(***REMOVED***
    ax = plt.subplot(1, 1, 1***REMOVED***
    ax.set_title('center', loc='center', fontsize=20, fontweight=700***REMOVED***
    ax.set_title('left', loc='left', fontsize=12, fontweight=400***REMOVED***
    ax.set_title('right', loc='right', fontsize=12, fontweight=400***REMOVED***


@cleanup
def test_set_position(***REMOVED***:
    fig, ax = plt.subplots(***REMOVED***

    # test set_position
    ann = ax.annotate(
        'test', (0, 0***REMOVED***, xytext=(0, 0***REMOVED***, textcoords='figure pixels'***REMOVED***
    plt.draw(***REMOVED***

    init_pos = ann.get_window_extent(fig.canvas.renderer***REMOVED***
    shift_val = 15
    ann.set_position((shift_val, shift_val***REMOVED******REMOVED***
    plt.draw(***REMOVED***
    post_pos = ann.get_window_extent(fig.canvas.renderer***REMOVED***

    for a, b in zip(init_pos.min, post_pos.min***REMOVED***:
        assert a + shift_val == b

    # test xyann
    ann = ax.annotate(
        'test', (0, 0***REMOVED***, xytext=(0, 0***REMOVED***, textcoords='figure pixels'***REMOVED***
    plt.draw(***REMOVED***

    init_pos = ann.get_window_extent(fig.canvas.renderer***REMOVED***
    shift_val = 15
    ann.xyann = (shift_val, shift_val***REMOVED***
    plt.draw(***REMOVED***
    post_pos = ann.get_window_extent(fig.canvas.renderer***REMOVED***

    for a, b in zip(init_pos.min, post_pos.min***REMOVED***:
        assert a + shift_val == b


def test_get_rotation_string(***REMOVED***:
    from matplotlib import text
    assert text.get_rotation('horizontal'***REMOVED*** == 0.
    assert text.get_rotation('vertical'***REMOVED*** == 90.
    assert text.get_rotation('15.'***REMOVED*** == 15.


def test_get_rotation_float(***REMOVED***:
    from matplotlib import text
    for i in [15., 16.70, 77.4***REMOVED***:
        assert text.get_rotation(i***REMOVED*** == i


def test_get_rotation_int(***REMOVED***:
    from matplotlib import text
    for i in [67, 16, 41***REMOVED***:
        assert text.get_rotation(i***REMOVED*** == float(i***REMOVED***


def test_get_rotation_raises(***REMOVED***:
    from matplotlib import text
    import sys
    if sys.version_info[:2***REMOVED*** < (2, 7***REMOVED***:
        raise SkipTest("assert_raises as context manager "
                       "not supported with Python < 2.7"***REMOVED***
    with assert_raises(ValueError***REMOVED***:
        text.get_rotation('hozirontal'***REMOVED***


def test_get_rotation_none(***REMOVED***:
    from matplotlib import text
    assert text.get_rotation(None***REMOVED*** == 0.0


def test_get_rotation_mod360(***REMOVED***:
    from matplotlib import text
    for i, j in zip([360., 377., 720+177.2***REMOVED***, [0., 17., 177.2***REMOVED******REMOVED***:
        assert_almost_equal(text.get_rotation(i***REMOVED***, j***REMOVED***


@image_comparison(baseline_images=['text_bboxclip'***REMOVED******REMOVED***
def test_bbox_clipping(***REMOVED***:
    plt.text(0.9, 0.2, 'Is bbox clipped?', backgroundcolor='r', clip_on=True***REMOVED***
    t = plt.text(0.9, 0.5, 'Is fancy bbox clipped?', clip_on=True***REMOVED***
    t.set_bbox({"boxstyle": "round, pad=0.1"***REMOVED******REMOVED***


@image_comparison(baseline_images=['annotation_negative_ax_coords'***REMOVED***,
                  extensions=['png'***REMOVED******REMOVED***
def test_annotation_negative_ax_coords(***REMOVED***:
    fig, ax = plt.subplots(***REMOVED***

    ax.annotate('+ pts',
                xytext=[30, 20***REMOVED***, textcoords='axes points',
                xy=[30, 20***REMOVED***, xycoords='axes points', fontsize=32***REMOVED***
    ax.annotate('- pts',
                xytext=[30, -20***REMOVED***, textcoords='axes points',
                xy=[30, -20***REMOVED***, xycoords='axes points', fontsize=32,
                va='top'***REMOVED***
    ax.annotate('+ frac',
                xytext=[0.75, 0.05***REMOVED***, textcoords='axes fraction',
                xy=[0.75, 0.05***REMOVED***, xycoords='axes fraction', fontsize=32***REMOVED***
    ax.annotate('- frac',
                xytext=[0.75, -0.05***REMOVED***, textcoords='axes fraction',
                xy=[0.75, -0.05***REMOVED***, xycoords='axes fraction', fontsize=32,
                va='top'***REMOVED***

    ax.annotate('+ pixels',
                xytext=[160, 25***REMOVED***, textcoords='axes pixels',
                xy=[160, 25***REMOVED***, xycoords='axes pixels', fontsize=32***REMOVED***
    ax.annotate('- pixels',
                xytext=[160, -25***REMOVED***, textcoords='axes pixels',
                xy=[160, -25***REMOVED***, xycoords='axes pixels', fontsize=32,
                va='top'***REMOVED***


@image_comparison(baseline_images=['annotation_negative_fig_coords'***REMOVED***,
                  extensions=['png'***REMOVED******REMOVED***
def test_annotation_negative_fig_coords(***REMOVED***:
    fig, ax = plt.subplots(***REMOVED***

    ax.annotate('+ pts',
                xytext=[10, 120***REMOVED***, textcoords='figure points',
                xy=[10, 120***REMOVED***, xycoords='figure points', fontsize=32***REMOVED***
    ax.annotate('- pts',
                xytext=[-10, 180***REMOVED***, textcoords='figure points',
                xy=[-10, 180***REMOVED***, xycoords='figure points', fontsize=32,
                va='top'***REMOVED***
    ax.annotate('+ frac',
                xytext=[0.05, 0.55***REMOVED***, textcoords='figure fraction',
                xy=[0.05, 0.55***REMOVED***, xycoords='figure fraction', fontsize=32***REMOVED***
    ax.annotate('- frac',
                xytext=[-0.05, 0.5***REMOVED***, textcoords='figure fraction',
                xy=[-0.05, 0.5***REMOVED***, xycoords='figure fraction', fontsize=32,
                va='top'***REMOVED***

    ax.annotate('+ pixels',
                xytext=[50, 50***REMOVED***, textcoords='figure pixels',
                xy=[50, 50***REMOVED***, xycoords='figure pixels', fontsize=32***REMOVED***
    ax.annotate('- pixels',
                xytext=[-50, 100***REMOVED***, textcoords='figure pixels',
                xy=[-50, 100***REMOVED***, xycoords='figure pixels', fontsize=32,
                va='top'***REMOVED***


@cleanup
def test_text_stale(***REMOVED***:
    fig, (ax1, ax2***REMOVED*** = plt.subplots(1, 2***REMOVED***
    plt.draw_all(***REMOVED***
    assert not ax1.stale
    assert not ax2.stale
    assert not fig.stale

    txt1 = ax1.text(.5, .5, 'aardvark'***REMOVED***
    assert ax1.stale
    assert txt1.stale
    assert fig.stale

    ann1 = ax2.annotate('aardvark', xy=[.5, .5***REMOVED******REMOVED***
    assert ax2.stale
    assert ann1.stale
    assert fig.stale

    plt.draw_all(***REMOVED***
    assert not ax1.stale
    assert not ax2.stale
    assert not fig.stale
