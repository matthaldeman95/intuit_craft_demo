# -*- coding: utf-8 -
#
# This file is part of gunicorn released under the MIT license.
# See the NOTICE for more information.

from optparse import make_option
import sys

from django.core.management.base import BaseCommand, CommandError

from gunicorn.app.djangoapp import DjangoApplicationCommand
from gunicorn.config import make_settings
from gunicorn import util


# monkey patch django.
# This patch make sure that we use real threads to get the ident which
# is going to happen if we are using gevent or eventlet.
***REMOVED***
    from django.db.backends import BaseDatabaseWrapper, DatabaseError

    if "validate_thread_sharing" in BaseDatabaseWrapper.__dict__:
        import thread
        _get_ident = thread.get_ident

        __old__init__ = BaseDatabaseWrapper.__init__

        def _init(self, *args, **kwargs***REMOVED***:
            __old__init__(self, *args, **kwargs***REMOVED***
            self._thread_ident = _get_ident(***REMOVED***

        def _validate_thread_sharing(self***REMOVED***:
            if (not self.allow_thread_sharing
                and self._thread_ident != _get_ident(***REMOVED******REMOVED***:
                    raise DatabaseError("DatabaseWrapper objects created in a "
                        "thread can only be used in that same thread. The object "
                        "with alias '%s' was created in thread id %s and this is "
                        "thread id %s."
                        % (self.alias, self._thread_ident, _get_ident(***REMOVED******REMOVED******REMOVED***

        BaseDatabaseWrapper.__init__ = _init
        BaseDatabaseWrapper.validate_thread_sharing = _validate_thread_sharing
except ImportError:
    pass


def make_options(***REMOVED***:
    opts = [
        make_option('--adminmedia', dest='admin_media_path', default='',
        help='Specifies the directory from which to serve admin media.'***REMOVED***
    ***REMOVED***

    g_settings = make_settings(ignore=("version"***REMOVED******REMOVED***
    keys = g_settings.keys(***REMOVED***
    for k in keys:
        if k in ('pythonpath', 'django_settings',***REMOVED***:
            continue

        setting = g_settings[k***REMOVED***
        if not setting.cli:
            continue

        args = tuple(setting.cli***REMOVED***

        kwargs = {
            "dest": setting.name,
            "metavar": setting.meta or None,
            "action": setting.action or "store",
            "type": setting.type or "string",
            "default": None,
            "help": "%s [%s***REMOVED***" % (setting.short, setting.default***REMOVED***
    ***REMOVED***
        if kwargs["action"***REMOVED*** != "store":
            kwargs.pop("type"***REMOVED***

        opts.append(make_option(*args, **kwargs***REMOVED******REMOVED***

    return tuple(opts***REMOVED***

GUNICORN_OPTIONS = make_options(***REMOVED***


class Command(BaseCommand***REMOVED***:
    option_list = BaseCommand.option_list + GUNICORN_OPTIONS
    help = "Starts a fully-functional Web server using gunicorn."
    args = '[optional port number, or ipaddr:port or unix:/path/to/sockfile***REMOVED***'

    # Validation is called explicitly each time the server is reloaded.
    requires_model_validation = False

    def handle(self, addrport=None, *args, **options***REMOVED***:

        # deprecation warning to announce future deletion in R21
        util.warn(***REMOVED***This command is deprecated.

        You should now run your application with the WSGI interface
        installed with your project. Ex.:

            gunicorn myproject.wsgi:application

        See https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/gunicorn/
        for more info.***REMOVED******REMOVED***

        if args:
            raise CommandError('Usage is run_gunicorn %s' % self.args***REMOVED***

        if addrport:
            sys.argv = sys.argv[:-1***REMOVED***
            options['bind'***REMOVED*** = addrport

        admin_media_path = options.pop('admin_media_path', ''***REMOVED***

        DjangoApplicationCommand(options, admin_media_path***REMOVED***.run(***REMOVED***
