from django.core import checks
from django.db.backends.base.validation import BaseDatabaseValidation
from django.utils.version import get_docs_version


class DatabaseValidation(BaseDatabaseValidation***REMOVED***:
    def check(self, **kwargs***REMOVED***:
        issues = super(DatabaseValidation, self***REMOVED***.check(**kwargs***REMOVED***
        issues.extend(self._check_sql_mode(**kwargs***REMOVED******REMOVED***
        return issues

    def _check_sql_mode(self, **kwargs***REMOVED***:
        with self.connection.cursor(***REMOVED*** as cursor:
            cursor.execute("SELECT @@sql_mode"***REMOVED***
            sql_mode = cursor.fetchone(***REMOVED***
        modes = set(sql_mode[0***REMOVED***.split(','***REMOVED*** if sql_mode else (***REMOVED******REMOVED***
        if not (modes & {'STRICT_TRANS_TABLES', 'STRICT_ALL_TABLES'***REMOVED******REMOVED***:
            return [checks.Warning(
                "MySQL Strict Mode is not set for database connection '%s'" % self.connection.alias,
                hint="MySQL's Strict Mode fixes many data integrity problems in MySQL, "
                     "such as data truncation upon insertion, by escalating warnings into "
                     "errors. It is strongly recommended you activate it. See: "
                     "https://docs.djangoproject.com/en/%s/ref/databases/#mysql-sql-mode"
                     % (get_docs_version(***REMOVED***,***REMOVED***,
                id='mysql.W002',
            ***REMOVED******REMOVED***
        return [***REMOVED***

    def check_field(self, field, **kwargs***REMOVED***:
        ***REMOVED***
        MySQL has the following field length restriction:
        No character (varchar***REMOVED*** fields can have a length exceeding 255
        characters if they have a unique index on them.
        ***REMOVED***
        from django.db import connection

        errors = super(DatabaseValidation, self***REMOVED***.check_field(field, **kwargs***REMOVED***

        # Ignore any related fields.
        if getattr(field, 'remote_field', None***REMOVED*** is None:
            field_type = field.db_type(connection***REMOVED***

            # Ignore any non-concrete fields
            if field_type is None:
                return errors

            if (field_type.startswith('varchar'***REMOVED*** and field.unique and
                    (field.max_length is None or int(field.max_length***REMOVED*** > 255***REMOVED******REMOVED***:
                errors.append(
                    checks.Error(
                        'MySQL does not allow unique CharFields to have a max_length > 255.',
                        obj=field,
                        id='mysql.E001',
                    ***REMOVED***
                ***REMOVED***
        return errors
