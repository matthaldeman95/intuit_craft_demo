from __future__ import absolute_import

import inspect

from django.utils import six


def getargspec(func***REMOVED***:
    if six.PY2:
        return inspect.getargspec(func***REMOVED***

    sig = inspect.signature(func***REMOVED***
    args = [
        p.name for p in sig.parameters.values(***REMOVED***
        if p.kind == inspect.Parameter.POSITIONAL_OR_KEYWORD
    ***REMOVED***
    varargs = [
        p.name for p in sig.parameters.values(***REMOVED***
        if p.kind == inspect.Parameter.VAR_POSITIONAL
    ***REMOVED***
    varargs = varargs[0***REMOVED*** if varargs else None
    varkw = [
        p.name for p in sig.parameters.values(***REMOVED***
        if p.kind == inspect.Parameter.VAR_KEYWORD
    ***REMOVED***
    varkw = varkw[0***REMOVED*** if varkw else None
    defaults = [
        p.default for p in sig.parameters.values(***REMOVED***
        if p.kind == inspect.Parameter.POSITIONAL_OR_KEYWORD and p.default is not p.empty
    ***REMOVED*** or None
    return args, varargs, varkw, defaults


def get_func_args(func***REMOVED***:
    if six.PY2:
        argspec = inspect.getargspec(func***REMOVED***
        return argspec.args[1:***REMOVED***  # ignore 'self'

    sig = inspect.signature(func***REMOVED***
    return [
        arg_name for arg_name, param in sig.parameters.items(***REMOVED***
        if param.kind == inspect.Parameter.POSITIONAL_OR_KEYWORD
    ***REMOVED***


def get_func_full_args(func***REMOVED***:
    ***REMOVED***
    Return a list of (argument name, default value***REMOVED*** tuples. If the argument
    does not have a default value, omit it in the tuple. Arguments such as
    *args and **kwargs are also included.
    ***REMOVED***
    if six.PY2:
        argspec = inspect.getargspec(func***REMOVED***
        args = argspec.args[1:***REMOVED***  # ignore 'self'
        defaults = argspec.defaults or [***REMOVED***
        # Split args into two lists depending on whether they have default value
        no_default = args[:len(args***REMOVED*** - len(defaults***REMOVED******REMOVED***
        with_default = args[len(args***REMOVED*** - len(defaults***REMOVED***:***REMOVED***
        # Join the two lists and combine it with default values
        args = [(arg,***REMOVED*** for arg in no_default***REMOVED*** + zip(with_default, defaults***REMOVED***
        # Add possible *args and **kwargs and prepend them with '*' or '**'
        varargs = [('*' + argspec.varargs,***REMOVED******REMOVED*** if argspec.varargs else [***REMOVED***
        kwargs = [('**' + argspec.keywords,***REMOVED******REMOVED*** if argspec.keywords else [***REMOVED***
        return args + varargs + kwargs

    sig = inspect.signature(func***REMOVED***
    args = [***REMOVED***
    for arg_name, param in sig.parameters.items(***REMOVED***:
        name = arg_name
        # Ignore 'self'
        if name == 'self':
            continue
        if param.kind == inspect.Parameter.VAR_POSITIONAL:
            name = '*' + name
        elif param.kind == inspect.Parameter.VAR_KEYWORD:
            name = '**' + name
        if param.default != inspect.Parameter.empty:
            args.append((name, param.default***REMOVED******REMOVED***
        else:
            args.append((name,***REMOVED******REMOVED***
    return args


def func_accepts_kwargs(func***REMOVED***:
    if six.PY2:
        # Not all callables are inspectable with getargspec, so we'll
        # try a couple different ways but in the end fall back on assuming
        # it is -- we don't want to prevent registration of valid but weird
        # callables.
        ***REMOVED***
            argspec = inspect.getargspec(func***REMOVED***
        except TypeError:
            ***REMOVED***
                argspec = inspect.getargspec(func.__call__***REMOVED***
            except (TypeError, AttributeError***REMOVED***:
                argspec = None
        return not argspec or argspec[2***REMOVED*** is not None

    return any(
        p for p in inspect.signature(func***REMOVED***.parameters.values(***REMOVED***
        if p.kind == p.VAR_KEYWORD
    ***REMOVED***


def func_accepts_var_args(func***REMOVED***:
    ***REMOVED***
    Return True if function 'func' accepts positional arguments *args.
    ***REMOVED***
    if six.PY2:
        return inspect.getargspec(func***REMOVED***[1***REMOVED*** is not None

    return any(
        p for p in inspect.signature(func***REMOVED***.parameters.values(***REMOVED***
        if p.kind == p.VAR_POSITIONAL
    ***REMOVED***


def func_has_no_args(func***REMOVED***:
    args = inspect.getargspec(func***REMOVED***[0***REMOVED*** if six.PY2 else [
        p for p in inspect.signature(func***REMOVED***.parameters.values(***REMOVED***
        if p.kind == p.POSITIONAL_OR_KEYWORD
    ***REMOVED***
    return len(args***REMOVED*** == 1


def func_supports_parameter(func, parameter***REMOVED***:
    if six.PY3:
        return parameter in inspect.signature(func***REMOVED***.parameters
    else:
        args, varargs, varkw, defaults = inspect.getargspec(func***REMOVED***
        return parameter in args
