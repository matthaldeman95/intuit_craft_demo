import re

from django.conf import settings
from django.http import HttpResponsePermanentRedirect
from django.utils.deprecation import MiddlewareMixin


class SecurityMiddleware(MiddlewareMixin***REMOVED***:
    def __init__(self, get_response=None***REMOVED***:
        self.sts_seconds = settings.SECURE_HSTS_SECONDS
        self.sts_include_subdomains = settings.SECURE_HSTS_INCLUDE_SUBDOMAINS
        self.content_type_nosniff = settings.SECURE_CONTENT_TYPE_NOSNIFF
        self.xss_filter = settings.SECURE_BROWSER_XSS_FILTER
        self.redirect = settings.SECURE_SSL_REDIRECT
        self.redirect_host = settings.SECURE_SSL_HOST
        self.redirect_exempt = [re.compile(r***REMOVED*** for r in settings.SECURE_REDIRECT_EXEMPT***REMOVED***
        self.get_response = get_response

    def process_request(self, request***REMOVED***:
        path = request.path.lstrip("/"***REMOVED***
        if (self.redirect and not request.is_secure(***REMOVED*** and
                not any(pattern.search(path***REMOVED***
                        for pattern in self.redirect_exempt***REMOVED******REMOVED***:
            host = self.redirect_host or request.get_host(***REMOVED***
            return HttpResponsePermanentRedirect(
                "https://%s%s" % (host, request.get_full_path(***REMOVED******REMOVED***
            ***REMOVED***

    def process_response(self, request, response***REMOVED***:
        if (self.sts_seconds and request.is_secure(***REMOVED*** and
                'strict-transport-security' not in response***REMOVED***:
            sts_header = "max-age=%s" % self.sts_seconds

            if self.sts_include_subdomains:
                sts_header = sts_header + "; includeSubDomains"

            response["strict-transport-security"***REMOVED*** = sts_header

        if self.content_type_nosniff and 'x-content-type-options' not in response:
            response["x-content-type-options"***REMOVED*** = "nosniff"

        if self.xss_filter and 'x-xss-protection' not in response:
            response["x-xss-protection"***REMOVED*** = "1; mode=block"

        return response
