from __future__ import unicode_literals

import logging

from django.conf import settings
from django.contrib.gis import gdal
from django.contrib.gis.geos import GEOSException, GEOSGeometry
from django.forms.widgets import Widget
from django.template import loader
from django.utils import six, translation

logger = logging.getLogger('django.contrib.gis'***REMOVED***


class BaseGeometryWidget(Widget***REMOVED***:
    ***REMOVED***
    The base class for rich geometry widgets.
    Renders a map using the WKT of the geometry.
    ***REMOVED***
    geom_type = 'GEOMETRY'
    map_srid = 4326
    map_width = 600
    map_height = 400
    display_raw = False

    supports_3d = False
    template_name = ''  # set on subclasses

    def __init__(self, attrs=None***REMOVED***:
        self.attrs = {***REMOVED***
        for key in ('geom_type', 'map_srid', 'map_width', 'map_height', 'display_raw'***REMOVED***:
            self.attrs[key***REMOVED*** = getattr(self, key***REMOVED***
        if attrs:
            self.attrs.update(attrs***REMOVED***

    def serialize(self, value***REMOVED***:
        return value.wkt if value else ''

    def deserialize(self, value***REMOVED***:
        ***REMOVED***
            return GEOSGeometry(value, self.map_srid***REMOVED***
        except (GEOSException, ValueError***REMOVED*** as err:
            logger.error("Error creating geometry from value '%s' (%s***REMOVED***", value, err***REMOVED***
        return None

    def render(self, name, value, attrs=None***REMOVED***:
        # If a string reaches here (via a validation error on another
        # field***REMOVED*** then just reconstruct the Geometry.
        if isinstance(value, six.string_types***REMOVED***:
            value = self.deserialize(value***REMOVED***

        if value:
            # Check that srid of value and map match
            if value.srid != self.map_srid:
                ***REMOVED***
                    ogr = value.ogr
                    ogr.transform(self.map_srid***REMOVED***
                    value = ogr
                except gdal.GDALException as err:
                    logger.error(
                        "Error transforming geometry from srid '%s' to srid '%s' (%s***REMOVED***",
                        value.srid, self.map_srid, err
                    ***REMOVED***

        context = self.build_attrs(
            attrs,
            name=name,
            module='geodjango_%s' % name.replace('-', '_'***REMOVED***,  # JS-safe
            serialized=self.serialize(value***REMOVED***,
            geom_type=gdal.OGRGeomType(self.attrs['geom_type'***REMOVED******REMOVED***,
            STATIC_URL=settings.STATIC_URL,
            LANGUAGE_BIDI=translation.get_language_bidi(***REMOVED***,
        ***REMOVED***
        return loader.render_to_string(self.template_name, context***REMOVED***


class OpenLayersWidget(BaseGeometryWidget***REMOVED***:
    template_name = 'gis/openlayers.html'

    class Media:
        js = (
            'http://openlayers.org/api/2.13.1/OpenLayers.js',
            'gis/js/OLMapWidget.js',
        ***REMOVED***


class OSMWidget(BaseGeometryWidget***REMOVED***:
    ***REMOVED***
    An OpenLayers/OpenStreetMap-based widget.
    ***REMOVED***
    template_name = 'gis/openlayers-osm.html'
    default_lon = 5
    default_lat = 47

    class Media:
        js = (
            'http://openlayers.org/api/2.13.1/OpenLayers.js',
            'gis/js/OLMapWidget.js',
        ***REMOVED***

    def __init__(self, attrs=None***REMOVED***:
        super(OSMWidget, self***REMOVED***.__init__(***REMOVED***
        for key in ('default_lon', 'default_lat'***REMOVED***:
            self.attrs[key***REMOVED*** = getattr(self, key***REMOVED***
        if attrs:
            self.attrs.update(attrs***REMOVED***

    @property
    def map_srid(self***REMOVED***:
        # Use the official spherical mercator projection SRID when GDAL is
        # available; otherwise, fallback to 900913.
        if gdal.HAS_GDAL:
            return 3857
        else:
            return 900913
