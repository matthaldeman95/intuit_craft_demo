import sys
from ctypes.util import find_library

from django.conf import settings
from django.core.exceptions import ImproperlyConfigured
from django.db.backends.sqlite3.base import (
    Database, DatabaseWrapper as SQLiteDatabaseWrapper, SQLiteCursorWrapper,
***REMOVED***
from django.utils import six

from .client import SpatiaLiteClient
from .features import DatabaseFeatures
from .introspection import SpatiaLiteIntrospection
from .operations import SpatiaLiteOperations
from .schema import SpatialiteSchemaEditor


class DatabaseWrapper(SQLiteDatabaseWrapper***REMOVED***:
    SchemaEditorClass = SpatialiteSchemaEditor

    def __init__(self, *args, **kwargs***REMOVED***:
        # Before we get too far, make sure pysqlite 2.5+ is installed.
        if Database.version_info < (2, 5, 0***REMOVED***:
            raise ImproperlyConfigured('Only versions of pysqlite 2.5+ are '
                                       'compatible with SpatiaLite and GeoDjango.'***REMOVED***

        # Trying to find the location of the SpatiaLite library.
        # Here we are figuring out the path to the SpatiaLite library
        # (`libspatialite`***REMOVED***. If it's not in the system library path (e.g., it
        # cannot be found by `ctypes.util.find_library`***REMOVED***, then it may be set
        # manually in the settings via the `SPATIALITE_LIBRARY_PATH` setting.
        self.spatialite_lib = getattr(settings, 'SPATIALITE_LIBRARY_PATH',
                                      find_library('spatialite'***REMOVED******REMOVED***
        if not self.spatialite_lib:
            raise ImproperlyConfigured('Unable to locate the SpatiaLite library. '
                                       'Make sure it is in your library path, or set '
                                       'SPATIALITE_LIBRARY_PATH in your settings.'
                                       ***REMOVED***
        super(DatabaseWrapper, self***REMOVED***.__init__(*args, **kwargs***REMOVED***
        self.features = DatabaseFeatures(self***REMOVED***
        self.ops = SpatiaLiteOperations(self***REMOVED***
        self.client = SpatiaLiteClient(self***REMOVED***
        self.introspection = SpatiaLiteIntrospection(self***REMOVED***

    def get_new_connection(self, conn_params***REMOVED***:
        conn = super(DatabaseWrapper, self***REMOVED***.get_new_connection(conn_params***REMOVED***
        # Enabling extension loading on the SQLite connection.
        ***REMOVED***
            conn.enable_load_extension(True***REMOVED***
        except AttributeError:
            raise ImproperlyConfigured(
                'The pysqlite library does not support C extension loading. '
                'Both SQLite and pysqlite must be configured to allow '
                'the loading of extensions to use SpatiaLite.'***REMOVED***
        # Loading the SpatiaLite library extension on the connection, and returning
        # the created cursor.
        cur = conn.cursor(factory=SQLiteCursorWrapper***REMOVED***
        ***REMOVED***
            cur.execute("SELECT load_extension(%s***REMOVED***", (self.spatialite_lib,***REMOVED******REMOVED***
        except Exception as msg:
            new_msg = (
                'Unable to load the SpatiaLite library extension '
                '"%s" because: %s'***REMOVED*** % (self.spatialite_lib, msg***REMOVED***
            six.reraise(ImproperlyConfigured, ImproperlyConfigured(new_msg***REMOVED***, sys.exc_info(***REMOVED***[2***REMOVED******REMOVED***
        cur.close(***REMOVED***
        return conn

    def prepare_database(self***REMOVED***:
        super(DatabaseWrapper, self***REMOVED***.prepare_database(***REMOVED***
        # Check if spatial metadata have been initialized in the database
        with self.cursor(***REMOVED*** as cursor:
            cursor.execute("PRAGMA table_info(geometry_columns***REMOVED***;"***REMOVED***
            if cursor.fetchall(***REMOVED*** == [***REMOVED***:
                arg = "1" if self.features.supports_initspatialmetadata_in_one_transaction else ""
                cursor.execute("SELECT InitSpatialMetaData(%s***REMOVED***" % arg***REMOVED***
