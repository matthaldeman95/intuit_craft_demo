from django.contrib.gis.db.models.fields import ExtentField
from django.db.models.aggregates import Aggregate

__all__ = ['Collect', 'Extent', 'Extent3D', 'MakeLine', 'Union'***REMOVED***


class GeoAggregate(Aggregate***REMOVED***:
    function = None
    is_extent = False

    def as_sql(self, compiler, connection***REMOVED***:
        # this will be called again in parent, but it's needed now - before
        # we get the spatial_aggregate_name
        connection.ops.check_expression_support(self***REMOVED***
        self.function = connection.ops.spatial_aggregate_name(self.name***REMOVED***
        return super(GeoAggregate, self***REMOVED***.as_sql(compiler, connection***REMOVED***

    def as_oracle(self, compiler, connection***REMOVED***:
        if not hasattr(self, 'tolerance'***REMOVED***:
            self.tolerance = 0.05
        self.extra['tolerance'***REMOVED*** = self.tolerance
        if not self.is_extent:
            self.template = '%(function***REMOVED***s(SDOAGGRTYPE(%(expressions***REMOVED***s,%(tolerance***REMOVED***s***REMOVED******REMOVED***'
        return self.as_sql(compiler, connection***REMOVED***

    def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False***REMOVED***:
        c = super(GeoAggregate, self***REMOVED***.resolve_expression(query, allow_joins, reuse, summarize, for_save***REMOVED***
        for expr in c.get_source_expressions(***REMOVED***:
            if not hasattr(expr.field, 'geom_type'***REMOVED***:
                raise ValueError('Geospatial aggregates only allowed on geometry fields.'***REMOVED***
        return c

    def convert_value(self, value, expression, connection, context***REMOVED***:
        return connection.ops.convert_geom(value, self.output_field***REMOVED***


class Collect(GeoAggregate***REMOVED***:
    name = 'Collect'


class Extent(GeoAggregate***REMOVED***:
    name = 'Extent'
    is_extent = '2D'

    def __init__(self, expression, **extra***REMOVED***:
        super(Extent, self***REMOVED***.__init__(expression, output_field=ExtentField(***REMOVED***, **extra***REMOVED***

    def convert_value(self, value, expression, connection, context***REMOVED***:
        return connection.ops.convert_extent(value, context.get('transformed_srid'***REMOVED******REMOVED***


class Extent3D(GeoAggregate***REMOVED***:
    name = 'Extent3D'
    is_extent = '3D'

    def __init__(self, expression, **extra***REMOVED***:
        super(Extent3D, self***REMOVED***.__init__(expression, output_field=ExtentField(***REMOVED***, **extra***REMOVED***

    def convert_value(self, value, expression, connection, context***REMOVED***:
        return connection.ops.convert_extent3d(value, context.get('transformed_srid'***REMOVED******REMOVED***


class MakeLine(GeoAggregate***REMOVED***:
    name = 'MakeLine'


class Union(GeoAggregate***REMOVED***:
    name = 'Union'
