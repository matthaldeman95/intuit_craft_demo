from ctypes import c_void_p

from django.contrib.gis.gdal.base import GDALBase
from django.contrib.gis.gdal.error import GDALException
from django.contrib.gis.gdal.prototypes import ds as vcapi, raster as rcapi
from django.utils import six
from django.utils.encoding import force_bytes, force_text


class Driver(GDALBase***REMOVED***:
    ***REMOVED***
    Wraps a GDAL/OGR Data Source Driver.
    For more information, see the C API source code:
    http://www.gdal.org/gdal_8h.html - http://www.gdal.org/ogr__api_8h.html
    ***REMOVED***

    # Case-insensitive aliases for some GDAL/OGR Drivers.
    # For a complete list of original driver names see
    # http://www.gdal.org/ogr_formats.html (vector***REMOVED***
    # http://www.gdal.org/formats_list.html (raster***REMOVED***
    _alias = {
        # vector
        'esri': 'ESRI Shapefile',
        'shp': 'ESRI Shapefile',
        'shape': 'ESRI Shapefile',
        'tiger': 'TIGER',
        'tiger/line': 'TIGER',
        # raster
        'tiff': 'GTiff',
        'tif': 'GTiff',
        'jpeg': 'JPEG',
        'jpg': 'JPEG',
***REMOVED***

    def __init__(self, dr_input***REMOVED***:
        ***REMOVED***
        Initializes an GDAL/OGR driver on either a string or integer input.
        ***REMOVED***
        if isinstance(dr_input, six.string_types***REMOVED***:
            # If a string name of the driver was passed in
            self.ensure_registered(***REMOVED***

            # Checking the alias dictionary (case-insensitive***REMOVED*** to see if an
            # alias exists for the given driver.
            if dr_input.lower(***REMOVED*** in self._alias:
                name = self._alias[dr_input.lower(***REMOVED******REMOVED***
            else:
                name = dr_input

            # Attempting to get the GDAL/OGR driver by the string name.
            for iface in (vcapi, rcapi***REMOVED***:
                driver = iface.get_driver_by_name(force_bytes(name***REMOVED******REMOVED***
                if driver:
                    break
        elif isinstance(dr_input, int***REMOVED***:
            self.ensure_registered(***REMOVED***
            for iface in (vcapi, rcapi***REMOVED***:
                driver = iface.get_driver(dr_input***REMOVED***
                if driver:
                    break
        elif isinstance(dr_input, c_void_p***REMOVED***:
            driver = dr_input
        else:
            raise GDALException('Unrecognized input type for GDAL/OGR Driver: %s' % str(type(dr_input***REMOVED******REMOVED******REMOVED***

        # Making sure we get a valid pointer to the OGR Driver
        if not driver:
            raise GDALException('Could not initialize GDAL/OGR Driver on input: %s' % str(dr_input***REMOVED******REMOVED***
        self.ptr = driver

    def __str__(self***REMOVED***:
        return self.name

    @classmethod
    def ensure_registered(cls***REMOVED***:
        ***REMOVED***
        Attempts to register all the data source drivers.
        ***REMOVED***
        # Only register all if the driver count is 0 (or else all drivers
        # will be registered over and over again***REMOVED***
        if not cls.driver_count(***REMOVED***:
            vcapi.register_all(***REMOVED***
            rcapi.register_all(***REMOVED***

    @classmethod
    def driver_count(cls***REMOVED***:
        ***REMOVED***
        Returns the number of GDAL/OGR data source drivers registered.
        ***REMOVED***
        return vcapi.get_driver_count(***REMOVED*** + rcapi.get_driver_count(***REMOVED***

    @property
    def name(self***REMOVED***:
        ***REMOVED***
        Returns description/name string for this driver.
        ***REMOVED***
        return force_text(rcapi.get_driver_description(self.ptr***REMOVED******REMOVED***
