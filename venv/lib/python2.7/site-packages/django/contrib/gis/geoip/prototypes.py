from ctypes import POINTER, Structure, c_char_p, c_float, c_int, string_at

from django.contrib.gis.geoip.libgeoip import free, lgeoip


# #### GeoIP C Structure definitions ####

class GeoIPRecord(Structure***REMOVED***:
    _fields_ = [('country_code', c_char_p***REMOVED***,
                ('country_code3', c_char_p***REMOVED***,
                ('country_name', c_char_p***REMOVED***,
                ('region', c_char_p***REMOVED***,
                ('city', c_char_p***REMOVED***,
                ('postal_code', c_char_p***REMOVED***,
                ('latitude', c_float***REMOVED***,
                ('longitude', c_float***REMOVED***,
                # TODO: In 1.4.6 this changed from `int dma_code;` to
                # `union {int metro_code; int dma_code;***REMOVED***;`.  Change
                # to a `ctypes.Union` in to accommodate in future when
                # pre-1.4.6 versions are no longer distributed.
                ('dma_code', c_int***REMOVED***,
                ('area_code', c_int***REMOVED***,
                ('charset', c_int***REMOVED***,
                ('continent_code', c_char_p***REMOVED***,
                ***REMOVED***
geoip_char_fields = [name for name, ctype in GeoIPRecord._fields_ if ctype is c_char_p***REMOVED***
GEOIP_DEFAULT_ENCODING = 'iso-8859-1'
geoip_encodings = {
    0: 'iso-8859-1',
    1: 'utf8',
***REMOVED***


class GeoIPTag(Structure***REMOVED***:
    pass

RECTYPE = POINTER(GeoIPRecord***REMOVED***
DBTYPE = POINTER(GeoIPTag***REMOVED***

# #### ctypes function prototypes ####

# GeoIP_lib_version appeared in version 1.4.7.
if hasattr(lgeoip, 'GeoIP_lib_version'***REMOVED***:
    GeoIP_lib_version = lgeoip.GeoIP_lib_version
    GeoIP_lib_version.argtypes = None
    GeoIP_lib_version.restype = c_char_p
else:
    GeoIP_lib_version = None

# For freeing memory allocated within a record
GeoIPRecord_delete = lgeoip.GeoIPRecord_delete
GeoIPRecord_delete.argtypes = [RECTYPE***REMOVED***
GeoIPRecord_delete.restype = None


# For retrieving records by name or address.
def check_record(result, func, cargs***REMOVED***:
    if result:
        # Checking the pointer to the C structure, if valid pull out elements
        # into a dictionary.
        rec = result.contents
        record = {fld: getattr(rec, fld***REMOVED*** for fld, ctype in rec._fields_***REMOVED***

        # Now converting the strings to unicode using the proper encoding.
        encoding = geoip_encodings[record['charset'***REMOVED******REMOVED***
        for char_field in geoip_char_fields:
            if record[char_field***REMOVED***:
                record[char_field***REMOVED*** = record[char_field***REMOVED***.decode(encoding***REMOVED***

        # Free the memory allocated for the struct & return.
        GeoIPRecord_delete(result***REMOVED***
        return record
    else:
        return None


def record_output(func***REMOVED***:
    func.argtypes = [DBTYPE, c_char_p***REMOVED***
    func.restype = RECTYPE
    func.errcheck = check_record
    return func
GeoIP_record_by_addr = record_output(lgeoip.GeoIP_record_by_addr***REMOVED***
GeoIP_record_by_name = record_output(lgeoip.GeoIP_record_by_name***REMOVED***


# For opening & closing GeoIP database files.
GeoIP_open = lgeoip.GeoIP_open
GeoIP_open.restype = DBTYPE
GeoIP_delete = lgeoip.GeoIP_delete
GeoIP_delete.argtypes = [DBTYPE***REMOVED***
GeoIP_delete.restype = None


# This is so the string pointer can be freed within Python.
class geoip_char_p(c_char_p***REMOVED***:
    pass


def check_string(result, func, cargs***REMOVED***:
    if result:
        s = string_at(result***REMOVED***
        free(result***REMOVED***
    else:
        s = ''
    return s.decode(GEOIP_DEFAULT_ENCODING***REMOVED***

GeoIP_database_info = lgeoip.GeoIP_database_info
GeoIP_database_info.restype = geoip_char_p
GeoIP_database_info.errcheck = check_string


# String output routines.
def string_output(func***REMOVED***:
    def _err_check(result, func, cargs***REMOVED***:
        if result:
            return result.decode(GEOIP_DEFAULT_ENCODING***REMOVED***
        return result
    func.restype = c_char_p
    func.errcheck = _err_check
    return func

GeoIP_country_code_by_addr = string_output(lgeoip.GeoIP_country_code_by_addr***REMOVED***
GeoIP_country_code_by_name = string_output(lgeoip.GeoIP_country_code_by_name***REMOVED***
GeoIP_country_name_by_addr = string_output(lgeoip.GeoIP_country_name_by_addr***REMOVED***
GeoIP_country_name_by_name = string_output(lgeoip.GeoIP_country_name_by_name***REMOVED***
