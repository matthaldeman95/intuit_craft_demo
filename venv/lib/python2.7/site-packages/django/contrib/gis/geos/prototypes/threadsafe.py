import threading

from django.contrib.gis.geos.libgeos import (
    CONTEXT_PTR, error_h, lgeos, notice_h,
***REMOVED***


class GEOSContextHandle(object***REMOVED***:
    ***REMOVED***
    Python object representing a GEOS context handle.
    ***REMOVED***
    def __init__(self***REMOVED***:
        # Initializing the context handler for this thread with
        # the notice and error handler.
        self.ptr = lgeos.initGEOS_r(notice_h, error_h***REMOVED***

    def __del__(self***REMOVED***:
        if self.ptr and lgeos:
            lgeos.finishGEOS_r(self.ptr***REMOVED***


# Defining a thread-local object and creating an instance
# to hold a reference to GEOSContextHandle for this thread.
class GEOSContext(threading.local***REMOVED***:
    handle = None

thread_context = GEOSContext(***REMOVED***


class GEOSFunc(object***REMOVED***:
    ***REMOVED***
    Class that serves as a wrapper for GEOS C Functions, and will
    use thread-safe function variants when available.
    ***REMOVED***
    def __init__(self, func_name***REMOVED***:
        ***REMOVED***
            # GEOS thread-safe function signatures end with '_r', and
            # take an additional context handle parameter.
            self.cfunc = getattr(lgeos, func_name + '_r'***REMOVED***
            self.threaded = True
            # Create a reference here to thread_context so it's not
            # garbage-collected before an attempt to call this object.
            self.thread_context = thread_context
        except AttributeError:
            # Otherwise, use usual function.
            self.cfunc = getattr(lgeos, func_name***REMOVED***
            self.threaded = False

    def __call__(self, *args***REMOVED***:
        if self.threaded:
            # If a context handle does not exist for this thread, initialize one.
            if not self.thread_context.handle:
                self.thread_context.handle = GEOSContextHandle(***REMOVED***
            # Call the threaded GEOS routine with pointer of the context handle
            # as the first argument.
            return self.cfunc(self.thread_context.handle.ptr, *args***REMOVED***
        else:
            return self.cfunc(*args***REMOVED***

    def __str__(self***REMOVED***:
        return self.cfunc.__name__

    # argtypes property
    def _get_argtypes(self***REMOVED***:
        return self.cfunc.argtypes

    def _set_argtypes(self, argtypes***REMOVED***:
        if self.threaded:
            new_argtypes = [CONTEXT_PTR***REMOVED***
            new_argtypes.extend(argtypes***REMOVED***
            self.cfunc.argtypes = new_argtypes
        else:
            self.cfunc.argtypes = argtypes

    argtypes = property(_get_argtypes, _set_argtypes***REMOVED***

    # restype property
    def _get_restype(self***REMOVED***:
        return self.cfunc.restype

    def _set_restype(self, restype***REMOVED***:
        self.cfunc.restype = restype

    restype = property(_get_restype, _set_restype***REMOVED***

    # errcheck property
    def _get_errcheck(self***REMOVED***:
        return self.cfunc.errcheck

    def _set_errcheck(self, errcheck***REMOVED***:
        self.cfunc.errcheck = errcheck

    errcheck = property(_get_errcheck, _set_errcheck***REMOVED***
