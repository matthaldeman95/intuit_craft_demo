***REMOVED***
import threading
import time
import warnings

from django.apps import apps
from django.core.signals import setting_changed
from django.db import connections, router
from django.db.utils import ConnectionRouter
from django.dispatch import Signal, receiver
from django.utils import timezone
from django.utils.functional import empty

template_rendered = Signal(providing_args=["template", "context"***REMOVED******REMOVED***

# Most setting_changed receivers are supposed to be added below,
# except for cases where the receiver is related to a contrib app.

# Settings that may not work well when using 'override_settings' (#19031***REMOVED***
COMPLEX_OVERRIDE_SETTINGS = {'DATABASES'***REMOVED***


@receiver(setting_changed***REMOVED***
def clear_cache_handlers(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'CACHES':
        from django.core.cache import caches
        caches._caches = threading.local(***REMOVED***


@receiver(setting_changed***REMOVED***
def update_installed_apps(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'INSTALLED_APPS':
        # Rebuild any AppDirectoriesFinder instance.
        from django.contrib.staticfiles.finders import get_finder
        get_finder.cache_clear(***REMOVED***
        # Rebuild management commands cache
        from django.core.management import get_commands
        get_commands.cache_clear(***REMOVED***
        # Rebuild get_app_template_dirs cache.
        from django.template.utils import get_app_template_dirs
        get_app_template_dirs.cache_clear(***REMOVED***
        # Rebuild translations cache.
        from django.utils.translation import trans_real
        trans_real._translations = {***REMOVED***


@receiver(setting_changed***REMOVED***
def update_connections_time_zone(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'TIME_ZONE':
        # Reset process time zone
        if hasattr(time, 'tzset'***REMOVED***:
            if kwargs['value'***REMOVED***:
                os.environ['TZ'***REMOVED*** = kwargs['value'***REMOVED***
            else:
                os.environ.pop('TZ', None***REMOVED***
            time.tzset(***REMOVED***

        # Reset local time zone cache
        timezone.get_default_timezone.cache_clear(***REMOVED***

    # Reset the database connections' time zone
    if kwargs['setting'***REMOVED*** in {'TIME_ZONE', 'USE_TZ'***REMOVED***:
        for conn in connections.all(***REMOVED***:
            ***REMOVED***
                del conn.timezone
            except AttributeError:
                pass
            ***REMOVED***
                del conn.timezone_name
            except AttributeError:
                pass
            tz_sql = conn.ops.set_time_zone_sql(***REMOVED***
            if tz_sql and conn.timezone_name:
                with conn.cursor(***REMOVED*** as cursor:
                    cursor.execute(tz_sql, [conn.timezone_name***REMOVED******REMOVED***


@receiver(setting_changed***REMOVED***
def clear_routers_cache(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'DATABASE_ROUTERS':
        router.routers = ConnectionRouter(***REMOVED***.routers


@receiver(setting_changed***REMOVED***
def reset_template_engines(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** in {
        'TEMPLATES',
        'DEBUG',
        'FILE_CHARSET',
        'INSTALLED_APPS',
***REMOVED***:
        from django.template import engines
        ***REMOVED***
            del engines.templates
        except AttributeError:
            pass
        engines._templates = None
        engines._engines = {***REMOVED***
        from django.template.engine import Engine
        Engine.get_default.cache_clear(***REMOVED***


@receiver(setting_changed***REMOVED***
def clear_serializers_cache(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'SERIALIZATION_MODULES':
        from django.core import serializers
        serializers._serializers = {***REMOVED***


@receiver(setting_changed***REMOVED***
def language_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** in {'LANGUAGES', 'LANGUAGE_CODE', 'LOCALE_PATHS'***REMOVED***:
        from django.utils.translation import trans_real
        trans_real._default = None
        trans_real._active = threading.local(***REMOVED***
    if kwargs['setting'***REMOVED*** in {'LANGUAGES', 'LOCALE_PATHS'***REMOVED***:
        from django.utils.translation import trans_real
        trans_real._translations = {***REMOVED***
        trans_real.check_for_language.cache_clear(***REMOVED***


@receiver(setting_changed***REMOVED***
def file_storage_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'DEFAULT_FILE_STORAGE':
        from django.core.files.storage import default_storage
        default_storage._wrapped = empty


@receiver(setting_changed***REMOVED***
def complex_setting_changed(**kwargs***REMOVED***:
    if kwargs['enter'***REMOVED*** and kwargs['setting'***REMOVED*** in COMPLEX_OVERRIDE_SETTINGS:
        # Considering the current implementation of the signals framework,
        # stacklevel=5 shows the line containing the override_settings call.
        warnings.warn("Overriding setting %s can lead to unexpected behavior."
                      % kwargs['setting'***REMOVED***, stacklevel=5***REMOVED***


@receiver(setting_changed***REMOVED***
def root_urlconf_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'ROOT_URLCONF':
        from django.urls import clear_url_caches, set_urlconf
        clear_url_caches(***REMOVED***
        set_urlconf(None***REMOVED***


@receiver(setting_changed***REMOVED***
def static_storage_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** in {
        'STATICFILES_STORAGE',
        'STATIC_ROOT',
        'STATIC_URL',
***REMOVED***:
        from django.contrib.staticfiles.storage import staticfiles_storage
        staticfiles_storage._wrapped = empty


@receiver(setting_changed***REMOVED***
def static_finders_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** in {
        'STATICFILES_DIRS',
        'STATIC_ROOT',
***REMOVED***:
        from django.contrib.staticfiles.finders import get_finder
        get_finder.cache_clear(***REMOVED***


@receiver(setting_changed***REMOVED***
def auth_password_validators_changed(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'AUTH_PASSWORD_VALIDATORS':
        from django.contrib.auth.password_validation import get_default_password_validators
        get_default_password_validators.cache_clear(***REMOVED***


@receiver(setting_changed***REMOVED***
def user_model_swapped(**kwargs***REMOVED***:
    if kwargs['setting'***REMOVED*** == 'AUTH_USER_MODEL':
        apps.clear_cache(***REMOVED***
