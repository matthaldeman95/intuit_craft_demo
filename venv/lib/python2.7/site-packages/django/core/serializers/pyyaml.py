***REMOVED***
YAML serializer.

Requires PyYaml (http://pyyaml.org/***REMOVED***, but that's checked for in __init__.
***REMOVED***

import collections
import decimal
import sys
from io import StringIO

import yaml

from django.core.serializers.base import DeserializationError
from django.core.serializers.python import (
    Deserializer as PythonDeserializer, Serializer as PythonSerializer,
***REMOVED***
from django.db import models
from django.utils import six

# Use the C (faster***REMOVED*** implementation if possible
***REMOVED***
    from yaml import CSafeLoader as SafeLoader
    from yaml import CSafeDumper as SafeDumper
except ImportError:
    from yaml import SafeLoader, SafeDumper


class DjangoSafeDumper(SafeDumper***REMOVED***:
    def represent_decimal(self, data***REMOVED***:
        return self.represent_scalar('tag:yaml.org,2002:str', str(data***REMOVED******REMOVED***

    def represent_ordered_dict(self, data***REMOVED***:
        return self.represent_mapping('tag:yaml.org,2002:map', data.items(***REMOVED******REMOVED***

DjangoSafeDumper.add_representer(decimal.Decimal, DjangoSafeDumper.represent_decimal***REMOVED***
DjangoSafeDumper.add_representer(collections.OrderedDict, DjangoSafeDumper.represent_ordered_dict***REMOVED***


class Serializer(PythonSerializer***REMOVED***:
    ***REMOVED***
    Convert a queryset to YAML.
    ***REMOVED***

    internal_use_only = False

    def handle_field(self, obj, field***REMOVED***:
        # A nasty special case: base YAML doesn't support serialization of time
        # types (as opposed to dates or datetimes, which it does support***REMOVED***. Since
        # we want to use the "safe" serializer for better interoperability, we
        # need to do something with those pesky times. Converting 'em to strings
        # isn't perfect, but it's better than a "!!python/time" type which would
        # halt deserialization under any other language.
        if isinstance(field, models.TimeField***REMOVED*** and getattr(obj, field.name***REMOVED*** is not None:
            self._current[field.name***REMOVED*** = str(getattr(obj, field.name***REMOVED******REMOVED***
        else:
            super(Serializer, self***REMOVED***.handle_field(obj, field***REMOVED***

    def end_serialization(self***REMOVED***:
        yaml.dump(self.objects, self.stream, Dumper=DjangoSafeDumper, **self.options***REMOVED***

    def getvalue(self***REMOVED***:
        # Grand-parent super
        return super(PythonSerializer, self***REMOVED***.getvalue(***REMOVED***


def Deserializer(stream_or_string, **options***REMOVED***:
    ***REMOVED***
    Deserialize a stream or string of YAML data.
    ***REMOVED***
    if isinstance(stream_or_string, bytes***REMOVED***:
        stream_or_string = stream_or_string.decode('utf-8'***REMOVED***
    if isinstance(stream_or_string, six.string_types***REMOVED***:
        stream = StringIO(stream_or_string***REMOVED***
    else:
        stream = stream_or_string
    ***REMOVED***
        for obj in PythonDeserializer(yaml.load(stream, Loader=SafeLoader***REMOVED***, **options***REMOVED***:
            yield obj
    except GeneratorExit:
        raise
    except Exception as e:
        # Map to deserializer error
        six.reraise(DeserializationError, DeserializationError(e***REMOVED***, sys.exc_info(***REMOVED***[2***REMOVED******REMOVED***
