import logging
***REMOVED***
import tempfile
import shutil
import json
from subprocess import check_call

from dateutil.zoneinfo import tar_open, METADATA_FN, ZONEFILENAME


def rebuild(filename, tag=None, format="gz", zonegroups=[***REMOVED***, metadata=None***REMOVED***:
    ***REMOVED***Rebuild the internal timezone info in dateutil/zoneinfo/zoneinfo*tar*

    filename is the timezone tarball from ftp.iana.org/tz.

    ***REMOVED***
    tmpdir = tempfile.mkdtemp(***REMOVED***
    zonedir = os.path.join(tmpdir, "zoneinfo"***REMOVED***
    moduledir = os.path.dirname(__file__***REMOVED***
    ***REMOVED***
        with tar_open(filename***REMOVED*** as tf:
            for name in zonegroups:
                tf.extract(name, tmpdir***REMOVED***
            filepaths = [os.path.join(tmpdir, n***REMOVED*** for n in zonegroups***REMOVED***
            ***REMOVED***
                check_call(["zic", "-d", zonedir***REMOVED*** + filepaths***REMOVED***
            except OSError as e:
                _print_on_nosuchfile(e***REMOVED***
                raise
        # write metadata file
        with open(os.path.join(zonedir, METADATA_FN***REMOVED***, 'w'***REMOVED*** as f:
            json.dump(metadata, f, indent=4, sort_keys=True***REMOVED***
        target = os.path.join(moduledir, ZONEFILENAME***REMOVED***
        with tar_open(target, "w:%s" % format***REMOVED*** as tf:
            for entry in os.listdir(zonedir***REMOVED***:
                entrypath = os.path.join(zonedir, entry***REMOVED***
                tf.add(entrypath, entry***REMOVED***
    finally:
        shutil.rmtree(tmpdir***REMOVED***

def _print_on_nosuchfile(e***REMOVED***:
    ***REMOVED***Print helpful troubleshooting message

    e is an exception raised by subprocess.check_call(***REMOVED***

    ***REMOVED***
    if e.errno == 2:
        logging.error(
            "Could not find zic. Perhaps you need to install "
            "libc-bin or some other package that provides it, "
            "or it's not in your PATH?"***REMOVED***
